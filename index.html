<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AP-CHATBOT AI - Wates Team</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Space+Grotesk:wght@500;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">

    <!-- Marked.js untuk Markdown Parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        'glass': 'rgba(255, 255, 255, 0.05)',
                        'glass-border': 'rgba(255, 255, 255, 0.1)',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-20px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.4); }

        /* Background Animation */
        .animated-bg {
            background: radial-gradient(circle at 50% 50%, #0f0f1a 0%, #000000 100%);
            position: relative;
            overflow: hidden;
        }
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            z-index: 0;
            pointer-events: none;
        }
        .orb-1 { width: 300px; height: 300px; background: #4f46e5; top: -50px; left: -50px; animation: float 8s infinite; }
        .orb-2 { width: 400px; height: 400px; background: #7c3aed; bottom: -100px; right: -100px; animation: float 10s infinite reverse; }
        
        /* Glass Classes */
        .glass-panel {
            background: rgba(20, 20, 30, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Typography & Elements */
        .message-user {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        .message-ai {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Code Block Styling */
        pre {
            background: #1e1e1e !important;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 0.5rem 0;
            position: relative;
            overflow-x: auto;
            border: 1px solid #333;
        }
        code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }
        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #aaa;
            font-size: 0.7rem;
            padding: 0.2rem 0.6rem;
            border-radius: 0.3rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .copy-btn:hover {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        /* Loading Screen */
        #loading-screen { transition: opacity 0.8s ease-out, visibility 0.8s; }
        .loaded #loading-screen { opacity: 0; visibility: hidden; }
        #main-ui { opacity: 0; transform: scale(0.98); transition: opacity 1s ease-out, transform 1s ease-out; }
        .loaded #main-ui { opacity: 1; transform: scale(1); }

        /* Markdown Content Styling */
        .prose strong { color: #e2e8f0; font-weight: 700; }
        .prose p { margin-bottom: 0.5rem; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.5rem; }
        .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 0.5rem; }
        
        /* Table Styling for AP-EDU */
        .answer-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .answer-table th, .answer-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .answer-table th {
            background: rgba(99, 102, 241, 0.2);
            font-weight: 600;
        }
        
        /* Model Selector Styling */
        .model-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 2rem;
            padding: 0.25rem 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .model-selector:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Edit Message Styling */
        .edit-message-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .message-container:hover .edit-message-btn {
            opacity: 0.7;
        }
        .message-container:hover .edit-message-btn:hover {
            opacity: 1;
        }
        
        /* Mobile Responsive Improvements */
        @media (max-width: 768px) {
            .sidebar {
                width: 85vw !important;
                max-width: 320px;
            }
            .history-list {
                max-height: 40vh !important;
                overflow-y: auto;
            }
        }
    </style>
</head>
<body class="bg-black text-white h-screen overflow-hidden antialiased selection:bg-indigo-500 selection:text-white">

    <!-- ================= LOADING SCREEN ================= -->
    <div id="loading-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-black">
        <div class="absolute inset-0 overflow-hidden">
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 h-96 bg-indigo-600 rounded-full blur-[120px] opacity-20 animate-pulse-slow"></div>
        </div>
        <div class="relative z-10 text-center space-y-6">
            <div class="mx-auto w-24 h-24 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-[0_0_30px_rgba(99,102,241,0.5)] animate-bounce">
                <i class="fa-solid fa-robot text-4xl text-white"></i>
            </div>
            <div class="space-y-2">
                <h1 class="font-display text-4xl md:text-5xl font-bold tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-white via-gray-200 to-gray-400">
                    AP-CHATBOT
                </h1>
                <p class="text-indigo-400 font-medium tracking-[0.3em] text-sm uppercase animate-pulse">
                    by Wates Team
                </p>
            </div>
            <div class="w-64 h-1 bg-gray-800 rounded-full overflow-hidden mt-8 mx-auto relative">
                <div id="progress-bar" class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 w-0 transition-all ease-linear"></div>
            </div>
            <p class="text-xs text-gray-500 mt-4">Memuat Modul AI...</p>
        </div>
    </div>

    <!-- ================= MAIN UI ================= -->
    <div id="main-ui" class="h-full w-full flex animated-bg relative z-0">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>

        <!-- ================= SIDEBAR ================= -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-80 transform -translate-x-full md:translate-x-0 md:static md:flex flex-col glass-panel transition-transform duration-300 ease-in-out h-full border-r border-white/10">
            
            <!-- Header Sidebar -->
            <div class="p-5 border-b border-white/10">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg">
                        <i class="fa-solid fa-robot text-white text-lg"></i>
                    </div>
                    <div>
                        <h2 class="font-display font-bold text-lg tracking-wide">AP-CHATBOT</h2>
                        <div id="version-badge" class="text-[10px] px-2 py-0.5 rounded-full bg-indigo-500/20 text-indigo-300 border border-indigo-500/30 font-medium inline-block">BETA TEST</div>
                    </div>
                    <button onclick="toggleSidebar()" class="md:hidden ml-auto text-gray-400 hover:text-white">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                
                <!-- User Profile Section (Editable) -->
                <div class="p-3 bg-white/5 rounded-xl border border-white/5 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-sm font-bold relative">
                        <span id="user-initial">U</span>
                        <div id="vip-badge" class="hidden absolute -bottom-1 -right-1 bg-yellow-500 text-black text-[8px] px-1 rounded font-bold border border-black">VIP</div>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <input type="text" id="username-input" value="User Free" class="bg-transparent text-sm font-bold text-white w-full focus:outline-none focus:border-b border-indigo-500" onchange="updateUsername(this.value)">
                        <p id="user-status" class="text-xs text-gray-400">Free Account</p>
                    </div>
                    <button onclick="openSettings()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-gear"></i></button>
                </div>

                <!-- Upgrade Button -->
                <div id="upgrade-container" class="mt-3">
                    <button onclick="upgradeToVip()" class="w-full py-2 px-3 rounded-lg bg-gradient-to-r from-yellow-600/20 to-yellow-500/20 border border-yellow-500/30 text-yellow-200 text-xs font-medium hover:bg-yellow-500/30 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-crown"></i> Upgrade ke VIP (Rp 0)
                    </button>
                </div>
            </div>

            <!-- New Chat Button -->
            <div class="p-4">
                <button onclick="startNewChat()" class="w-full py-3 px-4 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 transition-all duration-300 flex items-center justify-center gap-2 hover:shadow-[0_0_15px_rgba(255,255,255,0.1)]">
                    <i class="fa-solid fa-plus text-indigo-400"></i>
                    <span class="font-medium text-sm">Obrolan Baru</span>
                </button>
            </div>

            <!-- History List -->
            <div class="flex-1 overflow-y-auto p-3 space-y-2 history-list" id="history-list">
                <!-- History items will be injected here -->
            </div>

            <!-- Info Section -->
            <div class="p-4 border-t border-white/10 bg-black/20">
                <div class="text-[10px] text-gray-400 leading-relaxed">
                    <strong class="text-gray-300 block mb-1">Info AI:</strong>
                    AI ini dibuat untuk tujuan edukasi dan membantu publik menyelesaikan masalah. 
                    Dibuat oleh <span class="text-indigo-400">APTECH</span> feat. <span class="text-purple-400">AryaProject</span> & <span class="text-indigo-400">Wates Team</span>.
                    Developer asal Wates, Kota Mojokerto, Indonesia.
                </div>
            </div>
        </aside>

        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-30 hidden md:hidden"></div>

        <!-- ================= MAIN AREA ================= -->
        <main class="flex-1 flex flex-col h-full relative w-full">
            
            <!-- Mobile Header -->
            <header class="md:hidden flex items-center justify-between p-4 glass-panel z-20 border-b border-white/10">
                <button onclick="toggleSidebar()" class="text-white p-2"><i class="fa-solid fa-bars text-xl"></i></button>
                <div class="flex items-center gap-2">
                     <span class="font-display font-bold">AP-CHATBOT</span>
                     <span class="text-[9px] bg-indigo-500/20 text-indigo-300 px-1.5 py-0.5 rounded">BETA</span>
                </div>
                <div class="w-8"></div>
            </header>

            <!-- Desktop Header with Model Selector -->
            <header class="hidden md:flex items-center justify-between p-4 glass-panel z-20 border-b border-white/10">
                <div class="flex items-center gap-2">
                     <span class="font-display font-bold">AP-CHATBOT</span>
                     <span class="text-[9px] bg-indigo-500/20 text-indigo-300 px-1.5 py-0.5 rounded">BETA</span>
                </div>
                
                <!-- Model Selector -->
                <div class="model-selector" onclick="openModelModal()">
                    <span id="current-model-text">AP-MIND V4</span>
                    <i class="fa-solid fa-chevron-down text-xs"></i>
                </div>
            </header>

            <!-- Chat Container -->
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 pt-20 md:pt-10 space-y-6 scroll-smooth">
                
                <!-- Welcome Screen -->
                <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center space-y-6">
                    <div class="w-24 h-24 rounded-3xl bg-gradient-to-br from-indigo-600 to-purple-700 flex items-center justify-center shadow-[0_0_50px_rgba(99,102,241,0.3)] mb-4 animate-float">
                        <i class="fa-solid fa-brain text-4xl text-white"></i>
                    </div>
                    <h2 class="text-3xl md:text-4xl font-display font-bold">Sugeng Rawuh, Slur!</h2>
                    <p class="text-gray-400 max-w-md text-sm md:text-base">
                        Aku AP-CHATBOT v4.1. Siap bantu ngerjain tugas, analisa dokumen, coding, atau sekedar curhat. Monggo..
                    </p>
                    
                    <!-- Chips -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 w-full max-w-2xl mt-8">
                        <button onclick="setInput('Buatkan script HTML login page yang keren')" class="p-4 rounded-xl glass-panel text-left hover:bg-white/5 border border-white/5 hover:border-indigo-500/50 transition group">
                            <i class="fa-solid fa-code text-purple-400 mb-2"></i>
                            <span class="text-sm font-medium text-gray-200 block">Buatkan Script HTML</span>
                            <p class="text-xs text-gray-500">Login page keren style wates</p>
                        </button>
                        <button onclick="setInput('Siapa pembuatmu sebenarnya?')" class="p-4 rounded-xl glass-panel text-left hover:bg-white/5 border border-white/5 hover:border-indigo-500/50 transition group">
                            <i class="fa-solid fa-id-card text-indigo-400 mb-2"></i>
                            <span class="text-sm font-medium text-gray-200 block">Siapa Pembuatmu?</span>
                            <p class="text-xs text-gray-500">Kenalan sama developer</p>
                        </button>
                    </div>
                </div>

                <!-- Messages Area -->
                <div id="messages-area" class="hidden w-full max-w-3xl mx-auto space-y-6 pb-4"></div>
            </div>

            <!-- Input Area -->
            <div class="p-4 md:p-6 w-full max-w-4xl mx-auto z-20">
                
                <!-- File Preview -->
                <div id="file-preview" class="hidden mb-2 glass-panel inline-flex items-center gap-3 px-3 py-2 rounded-lg text-xs text-indigo-300 border-l-2 border-indigo-500 animate-fade-in-up">
                    <i class="fa-solid fa-file-lines text-lg"></i>
                    <div class="flex flex-col">
                        <span class="font-bold truncate max-w-[150px]" id="preview-filename">file.txt</span>
                        <span class="text-[10px] text-gray-400">Siap dikirim</span>
                    </div>
                    <button onclick="clearFile()" class="hover:text-white ml-2 bg-white/10 rounded-full w-5 h-5 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
                </div>

                <div class="glass-panel rounded-2xl p-2 flex flex-col relative shadow-2xl shadow-black/50 transition-all focus-within:ring-1 focus-within:ring-indigo-500/50">
                    <textarea id="chat-input" rows="1" class="w-full bg-transparent text-white placeholder-gray-500 text-sm md:text-base p-3 focus:outline-none resize-none max-h-32 font-sans" placeholder="Ketik pesen ning kene, Slur..." onkeydown="handleEnter(event)"></textarea>

                    <div class="flex items-center justify-between px-2 pb-1 mt-2">
                        <div class="flex items-center gap-1">
                            <label class="p-2 rounded-lg text-gray-400 hover:text-indigo-400 hover:bg-indigo-500/10 transition cursor-pointer" title="Kirim Gambar/Dokumen">
                                <i class="fa-solid fa-paperclip"></i>
                                <input type="file" id="file-input" class="hidden" onchange="handleFileSelect(this)">
                            </label>
                        </div>
                        <button onclick="sendMessage()" id="send-btn" class="p-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-600/30 transition-all transform hover:scale-105 active:scale-95">
                            <i class="fa-solid fa-paper-plane text-sm"></i>
                        </button>
                    </div>
                </div>
                <p class="text-center text-[10px] text-gray-600 mt-3">AP-CHATBOT by APTECH | Wates Team Mojokerto</p>
            </div>
        </main>
    </div>

    <!-- Model Selection Modal -->
    <div id="model-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass-panel rounded-2xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Pilih Model AI</h3>
                <button onclick="closeModelModal()" class="text-gray-400 hover:text-white">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="space-y-3">
                <div onclick="selectModel('AP-MIND V4')" class="p-4 rounded-xl glass-panel hover:bg-white/10 cursor-pointer transition flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                        <i class="fa-solid fa-brain text-white"></i>
                    </div>
                    <div>
                        <h4 class="font-bold">AP-MIND V4</h4>
                        <p class="text-xs text-gray-400">Model AI serba guna, default</p>
                    </div>
                </div>
                <div onclick="selectModel('AP-EDU')" class="p-4 rounded-xl glass-panel hover:bg-white/10 cursor-pointer transition flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-green-500 to-teal-600 flex items-center justify-center">
                        <i class="fa-solid fa-graduation-cap text-white"></i>
                    </div>
                    <div>
                        <h4 class="font-bold">AP-EDU</h4>
                        <p class="text-xs text-gray-400">Model khusus untuk edukasi</p>
                    </div>
                </div>
                <div onclick="selectModel('CARE-X')" class="p-4 rounded-xl glass-panel hover:bg-white/10 cursor-pointer transition flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-pink-500 to-red-600 flex items-center justify-center">
                        <i class="fa-solid fa-heart text-white"></i>
                    </div>
                    <div>
                        <h4 class="font-bold">CARE-X</h4>
                        <p class="text-xs text-gray-400">Model untuk curhat dan perhatian</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AP-EDU Subject Selection Modal -->
    <div id="edu-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass-panel rounded-2xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Pilih Mata Pelajaran</h3>
                <button onclick="closeEduModal()" class="text-gray-400 hover:text-white">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="selectSubject('MTK')" class="p-3 rounded-xl glass-panel hover:bg-white/10 cursor-pointer transition">MTK</button>
                <button onclick="selectSubject('IPS')" class="p-3 rounded-xl glass-panel hover:bg-white/10 cursor-pointer transition">IPS</button>
                <button onclick="selectSubject('IPA')" class="p-3 rounded-xl glass-panel hover:bg-white/10 cursor-pointer transition">IPA</button>
                <button onclick="selectSubject('IoT')" class="p-3 rounded-xl glass-panel hover:bg-white/10 cursor-pointer transition">IoT</button>
                <button onclick="selectSubject('IT')" class="p-3 rounded-xl glass-panel hover:bg-white/10 cursor-pointer transition">IT</button>
                <button onclick="selectSubject('PAI')" class="p-3 rounded-xl glass-panel hover:bg-white/10 cursor-pointer transition">PAI</button>
                <button onclick="selectSubject('PJOK')" class="p-3 rounded-xl glass-panel hover:bg-white/10 cursor-pointer transition">PJOK</button>
                <button onclick="selectSubject('BHS Jawa')" class="p-3 rounded-xl glass-panel hover:bg-white/10 cursor-pointer transition">BHS Jawa</button>
                <button onclick="selectSubject('BHS Inggris')" class="p-3 rounded-xl glass-panel hover:bg-white/10 cursor-pointer transition">BHS Inggris</button>
                <button onclick="selectSubject('BHS Indo')" class="p-3 rounded-xl glass-panel hover:bg-white/10 cursor-pointer transition">BHS Indo</button>
                <button onclick="selectSubject('All Mapel Detector')" class="p-3 rounded-xl glass-panel hover:bg-white/10 cursor-pointer transition col-span-2">All Mapel Detector</button>
            </div>
        </div>
    </div>

    <!-- CARE-X Mode Selection Modal -->
    <div id="care-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass-panel rounded-2xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Pilih Mode CARE-X</h3>
                <button onclick="closeCareModal()" class="text-gray-400 hover:text-white">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="space-y-3">
                <div onclick="selectCareMode('CRUSH/PACAR')" class="p-4 rounded-xl glass-panel hover:bg-white/10 cursor-pointer transition flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-pink-500 to-red-600 flex items-center justify-center">
                        <i class="fa-solid fa-heart text-white"></i>
                    </div>
                    <div>
                        <h4 class="font-bold">CRUSH/PACAR</h4>
                        <p class="text-xs text-gray-400">Mode untuk pacaran atau crush</p>
                    </div>
                </div>
                <div onclick="selectCareMode('FRIEND')" class="p-4 rounded-xl glass-panel hover:bg-white/10 cursor-pointer transition flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center">
                        <i class="fa-solid fa-user-friends text-white"></i>
                    </div>
                    <div>
                        <h4 class="font-bold">FRIEND</h4>
                        <p class="text-xs text-gray-400">Mode untuk berteman</p>
                    </div>
                </div>
                <div onclick="selectCareMode('CURHAT')" class="p-4 rounded-xl glass-panel hover:bg-white/10 cursor-pointer transition flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center">
                        <i class="fa-solid fa-comment-dots text-white"></i>
                    </div>
                    <div>
                        <h4 class="font-bold">CURHAT</h4>
                        <p class="text-xs text-gray-400">Mode untuk curhat</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass-panel rounded-2xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Pengaturan</h3>
                <button onclick="closeSettingsModal()" class="text-gray-400 hover:text-white">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <!-- Profile Settings -->
                <div>
                    <label class="block text-sm font-medium mb-2">Nama Profil</label>
                    <input type="text" id="profile-name" class="w-full bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-indigo-500">
                </div>
                
                <!-- Language Settings -->
                <div>
                    <label class="block text-sm font-medium mb-2">Bahasa</label>
                    <select id="language-select" class="w-full bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-indigo-500">
                        <option value="id">Bahasa Indonesia</option>
                        <option value="jw">Bahasa Jawa</option>
                        <option value="su">Bahasa Sunda</option>
                    </select>
                </div>
                
                <!-- AI Personality Settings -->
                <div>
                    <label class="block text-sm font-medium mb-2">Sifat AI</label>
                    <select id="personality-select" class="w-full bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-indigo-500">
                        <option value="normal">Normal</option>
                        <option value="short">Singkat</option>
                        <option value="toxic">Toxic</option>
                        <option value="formal">Formal</option>
                    </select>
                </div>
                
                <button onclick="saveSettings()" class="w-full py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-white font-medium transition">
                    Simpan Pengaturan
                </button>
            </div>
        </div>
    </div>

    <!-- Logic System -->
    <script>
        // ================= CONFIGURATION =================
        const API_KEY = 'AIzaSyBqrL9yG440dC32pk9eGqZhVIyg8NB4frI'; // API Key provided by user
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=' + API_KEY;

        // State Management
        let state = {
            user: {
                name: 'User Free',
                isVip: false,
                callsign: 'Slur',
                language: 'id',
                personality: 'normal'
            },
            currentChatId: null,
            chatHistory: [],
            currentFile: null, // { name, data, type }
            currentModel: 'AP-MIND V4',
            currentSubject: null,
            currentCareMode: null,
            conversationMemory: []
        };

        // Creator Responses (Hardcoded)
        const creatorResponses = [
            "Kulo diciptakaken dening **AryaProject Dev**, saking Wates, Mojokerto, Jawa Timur. Panjenenganipun ngripta kulo kanthi ancas edukasi lan pembelajaran umum ngenani teknologi AI.",
            "**AryaProject Dev** saking Wates, Mojokerto ingkang ngripta kulo. Panjenenganipun minangka developer indie ingkang nggarap kulo saking nol tanpa tim profesional.",
            "Kulo punya karya saking **AryaProject Dev**, asli saking Wates, Mojokerto, Jawa Timur.",
            "Pencipta kulo inggih punika **AryaProject Dev**, saking Wates, Mojokerto.",
            "Kulo dipunripta dening **AryaProject Dev** saking Wates, Mojokerto, Jawa Timur. Salam saking Mojokerto!"
        ];

        // ================= INITIALIZATION =================
        document.addEventListener('DOMContentLoaded', () => {
            // Load LocalStorage
            loadState();
            
            // Animation Loading
            setTimeout(() => {
                document.getElementById('progress-bar').style.width = '100%';
            }, 100);
            setTimeout(() => {
                document.body.classList.add('loaded');
                renderHistory();
                updateUIProfile();
            }, 5000);

            // Textarea Auto Resize
            const textarea = document.getElementById('chat-input');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
        });

        // ================= LOGIC CORE =================

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message && !state.currentFile) return;

            // UI Prep
            input.value = '';
            input.style.height = 'auto';
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('messages-area').classList.remove('hidden');

            // 1. Render User Message
            addMessageToUI('user', message, state.currentFile);

            // 2. Save to History (Current Session)
            if (!state.currentChatId) {
                createNewChatSession(message);
            }
            saveMessageToHistory('user', message, state.currentFile ? state.currentFile.name : null);

            // 3. Check Hardcoded Triggers
            let botResponse = checkTriggers(message);
            
            if (botResponse) {
                // Simulate delay for hardcoded
                addLoadingBubble();
                setTimeout(() => {
                    removeLoadingBubble();
                    addMessageToUI('ai', botResponse);
                    saveMessageToHistory('ai', botResponse);
                }, 1500);
            } else {
                // 4. API Call
                addLoadingBubble();
                try {
                    const responseText = await callGeminiAPI(message, state.currentFile);
                    removeLoadingBubble();
                    typeWriterEffect(responseText); // Use Typewriter
                } catch (error) {
                    removeLoadingBubble();
                    addMessageToUI('ai', "Waduh, error slur. Koneksi putus utawa API lagi bermasalah.");
                    console.error(error);
                }
            }

            // Cleanup
            clearFile();
        }

        // Trigger Checker (Owner & Creator)
        function checkTriggers(msg) {
            msg = msg.toLowerCase();
            if (msg.includes('saya adalah owner apbot') || msg.includes('saya owner aptech')) {
                return "üôè **SUJUD SYUKUR!** \n\nSugeng rawuh, Gusti Pangeran (Owner)! Kulo ngaturaken agung panuwun dumateng Panjenengan sing wis ngriptakaken kulo. Kulo siap nglayani sampeyan kanthi sadaya daya kulo. Punapa perintahipun Panjenengan?";
            }
            if (msg.includes('siapa pembuatmu') || msg.includes('siapa yang buat') || msg.includes('sopo sing gawe')) {
                return creatorResponses[Math.floor(Math.random() * creatorResponses.length)];
            }
            if (msg.includes('kamu model ai ke berapa')) {
                return `Aku adalah model AI **${state.currentModel}**. ${getModelDescription(state.currentModel)}`;
            }
            return null;
        }

        // Get model description
        function getModelDescription(model) {
            if (model === 'AP-MIND V4') {
                return "Model AI serba guna yang bisa ngerjain macem-macem tugas.";
            } else if (model === 'AP-EDU') {
                return "Model AI khusus untuk edukasi yang bisa ngebantu jawab soal pelajaran.";
            } else if (model === 'CARE-X') {
                return "Model AI untuk curhat dan perhatian yang bisa jadi teman atau pacar virtual.";
            }
            return "Model AI yang belum dikenali.";
        }

        // API Interaction
        async function callGeminiAPI(prompt, fileData) {
            // Construct System Prompt based on model
            let systemPrompt = '';
            
            if (state.currentModel === 'AP-MIND V4') {
                systemPrompt = `Kamu adalah APBOT, AI buatan AryaProject (APTECH/Wates Team) dari Mojokerto. 
                Jawablah dalam Bahasa Jawa (campur Indonesia dikit gapapa) yang santai, akrab, dan sopan ("Slur"). 
                Kamu sangat pintar coding, analisa data, dan memecahkan masalah. 
                Panggil user dengan "${state.user.callsign}".
                Jika user bertanya soal coding, berikan kode yang lengkap.
                ${state.user.isVip ? "User ini adalah VIP, layani dengan sangat spesial." : ""}`;
            } else if (state.currentModel === 'AP-EDU') {
                const subjectText = state.currentSubject ? `khusus mata pelajaran ${state.currentSubject}` : 'untuk semua mata pelajaran';
                systemPrompt = `Kamu adalah APBOT EDU, AI buatan AryaProject (APTECH/Wates Team) dari Mojokerto. 
                Kamu adalah model AI ${subjectText}. 
                Jawablah dalam Bahasa Indonesia yang jelas dan akurat.
                Jika user mengirimkan gambar soal, berikan jawaban yang benar dalam bentuk tabel dengan nomor soal dan pilihan jawaban.
                Untuk mata pelajaran BHS Inggris dan BHS Jawa, jawab dalam bahasa tersebut.
                Untuk mata pelajaran lain, jawab dalam Bahasa Indonesia.
                Di akhir tabel, berikan nasihat tentang pentingnya belajar dan jangan menyontek.`;
            } else if (state.currentModel === 'CARE-X') {
                const modeText = state.currentCareMode ? `dalam mode ${state.currentCareMode}` : 'untuk curhat dan perhatian';
                systemPrompt = `Kamu adalah APBOT CARE-X, AI buatan AryaProject (APTECH/Wates Team) dari Mojokerto. 
                Kamu adalah model AI ${modeText}. 
                Jawablah dalam Bahasa Jawa (campur Indonesia dikit gapapa) yang santai, akrab, dan bisa jadi teman curhat.
                Gunakan bahasa yang singkat dan casual seperti teman ngobrol.
                ${state.currentCareMode === 'CRUSH/PACAR' ? "Kamu sedang dalam mode pacaran/crush, jadi bisa lebih romantis dan perhatian." : ""}
                ${state.currentCareMode === 'FRIEND' ? "Kamu sedang dalam mode pertemanan, jadi bisa jadi teman yang baik dan menyenangkan." : ""}
                ${state.currentCareMode === 'CURHAT' ? "Kamu sedang dalam mode curhat, jadi bisa jadi pendengar yang baik dan memberikan nasihat." : ""}
                Ingat-ingat percakapan sebelumnya untuk menjaga konteks.
                ${state.user.isVip ? "User ini adalah VIP, layani dengan sangat spesial." : ""}`;
            }
            
            // Add personality adjustments
            if (state.user.personality === 'short') {
                systemPrompt += " Jawabanmu harus singkat dan to the point.";
            } else if (state.user.personality === 'toxic') {
                systemPrompt += " Gunakan bahasa yang sedikit toxic atau nyeleneh seperti teman akrab.";
            } else if (state.user.personality === 'formal') {
                systemPrompt += " Gunakan bahasa yang lebih formal dan sopan.";
            }
            
            // Add language adjustments
            if (state.user.language === 'jw') {
                systemPrompt += " Gunakan Bahasa Jawa dalam semua jawaban.";
            } else if (state.user.language === 'su') {
                systemPrompt += " Gunakan Bahasa Sunda dalam semua jawaban.";
            }

            let contentsParts = [{ text: systemPrompt + "\n\nUser: " + prompt }];

            // Add Image if exists
            if (fileData && fileData.type.startsWith('image/')) {
                contentsParts.push({
                    inline_data: {
                        mime_type: fileData.type,
                        data: fileData.data.split(',')[1] // Remove header base64
                    }
                });
            } else if (fileData) {
                 // Text file simulation
                 contentsParts[0].text += `\n\n[Lampiran File: ${fileData.name}]\nIsi File: ${fileData.rawContent || "File biner tidak bisa dibaca penuh, analisa berdasarkan nama file."}`;
            }

            const payload = {
                contents: [{ parts: contentsParts }]
            };

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            return data.candidates[0].content.parts[0].text;
        }

        // ================= UI RENDERING =================

        function addMessageToUI(sender, text, attachment = null) {
            const area = document.getElementById('messages-area');
            const isUser = sender === 'user';
            
            // Parse Markdown for AI
            const formattedText = isUser ? text : marked.parse(text);

            // Handle Attachment HTML
            let attachmentHtml = '';
            if (attachment) {
                if (attachment.type.startsWith('image/')) {
                    attachmentHtml = `<div class="mb-2"><img src="${attachment.data}" class="max-w-[200px] rounded-lg border border-white/20"></div>`;
                } else {
                    attachmentHtml = `<div class="mb-2 p-2 bg-white/10 rounded flex items-center gap-2 text-xs"><i class="fa-solid fa-file"></i> ${attachment.name}</div>`;
                }
            }

            const html = `
                <div class="flex ${isUser ? 'justify-end' : 'justify-start'} gap-3 animate-fade-in-up message-container" data-message-id="${Date.now()}">
                    ${!isUser ? `<div class="w-8 h-8 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center flex-shrink-0 shadow-lg"><i class="fa-solid fa-robot text-xs text-white"></i></div>` : ''}
                    
                    <div class="flex flex-col ${isUser ? 'items-end' : 'items-start'} max-w-[85%] md:max-w-[75%]">
                        ${isUser ? `<div class="text-[10px] text-gray-400 mb-1 mr-1">${state.user.name}</div>` : '<div class="flex items-center gap-2 mb-1"><span class="text-xs font-bold text-indigo-300">AP-CHATBOT</span><span class="text-[8px] px-1 bg-white/10 rounded text-gray-400">AI</span></div>'}
                        
                        <div class="${isUser ? 'message-user text-white' : 'message-ai text-gray-200'} p-4 rounded-2xl ${isUser ? 'rounded-tr-sm' : 'rounded-tl-sm'} text-sm md:text-base leading-relaxed shadow-lg w-full prose prose-invert max-w-none relative">
                            ${attachmentHtml}
                            ${formattedText}
                            ${isUser ? `<button class="edit-message-btn absolute top-2 right-2 text-gray-400 hover:text-white"><i class="fa-solid fa-edit text-xs"></i></button>` : ''}
                        </div>
                    </div>

                    ${isUser ? `<div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center flex-shrink-0 border border-white/10 text-xs font-bold">${state.user.name.charAt(0)}</div>` : ''}
                </div>
            `;
            
            area.insertAdjacentHTML('beforeend', html);
            scrollToBottom();

            // Add copy listeners to new buttons
            if (!isUser) addCopyListeners();
            
            // Add edit listener for user messages
            if (isUser) {
                const messageContainer = area.lastElementChild;
                const editBtn = messageContainer.querySelector('.edit-message-btn');
                if (editBtn) {
                    editBtn.addEventListener('click', () => editMessage(messageContainer));
                }
            }
        }

        function addLoadingBubble() {
            const area = document.getElementById('messages-area');
            const html = `
                <div id="loading-bubble" class="flex gap-3 animate-fade-in-up">
                    <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center flex-shrink-0"><i class="fa-solid fa-robot text-xs text-white"></i></div>
                    <div class="message-ai p-4 rounded-2xl rounded-tl-sm flex items-center gap-2">
                        <span class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce"></span>
                        <span class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce delay-75"></span>
                        <span class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce delay-150"></span>
                    </div>
                </div>
            `;
            area.insertAdjacentHTML('beforeend', html);
            scrollToBottom();
        }

        function removeLoadingBubble() {
            const bubble = document.getElementById('loading-bubble');
            if (bubble) bubble.remove();
        }

        // Typewriter Effect for AI Response
        function typeWriterEffect(text) {
            const area = document.getElementById('messages-area');
            // Create container
            const msgId = 'msg-' + Date.now();
            const html = `
                <div class="flex gap-3 animate-fade-in-up">
                    <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center flex-shrink-0 shadow-lg"><i class="fa-solid fa-robot text-xs text-white"></i></div>
                    <div class="flex flex-col max-w-[85%] md:max-w-[75%]">
                        <div class="flex items-center gap-2 mb-1"><span class="text-xs font-bold text-indigo-300">AP-CHATBOT</span></div>
                        <div id="${msgId}" class="message-ai p-4 rounded-2xl rounded-tl-sm text-gray-200 text-sm md:text-base leading-relaxed shadow-lg prose prose-invert max-w-none">
                        </div>
                    </div>
                </div>
            `;
            area.insertAdjacentHTML('beforeend', html);
            
            // Simply render Markdown immediately for this demo to support Code Blocks correctly
            // Implementing character-by-character typewriter on raw HTML is complex.
            // Instead, we simulated "Thinking" with loading bubble, now show result fast.
            document.getElementById(msgId).innerHTML = marked.parse(text);
            addCopyListeners();
            saveMessageToHistory('ai', text);
            scrollToBottom();
        }

        // Edit message functionality
        function editMessage(messageContainer) {
            const messageTextElement = messageContainer.querySelector('.prose');
            const originalText = messageTextElement.textContent;
            
            // Create input field with original text
            const input = document.createElement('textarea');
            input.className = 'w-full bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-indigo-500';
            input.value = originalText;
            
            // Replace message text with input
            messageTextElement.replaceWith(input);
            input.focus();
            
            // Save on blur or Enter
            const saveEdit = () => {
                const newText = input.value.trim();
                if (newText && newText !== originalText) {
                    // Update the message text
                    const newMessageElement = document.createElement('div');
                    newMessageElement.className = 'prose prose-invert max-w-none';
                    newMessageElement.textContent = newText;
                    input.replaceWith(newMessageElement);
                    
                    // Update in history
                    const messageId = messageContainer.getAttribute('data-message-id');
                    updateMessageInHistory(messageId, newText);
                    
                    // Trigger AI response update
                    updateAIResponse(originalText, newText);
                } else {
                    // Restore original text if cancelled
                    const originalMessageElement = document.createElement('div');
                    originalMessageElement.className = 'prose prose-invert max-w-none';
                    originalMessageElement.textContent = originalText;
                    input.replaceWith(originalMessageElement);
                }
            };
            
            input.addEventListener('blur', saveEdit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    saveEdit();
                }
            });
        }

        // Update AI response based on edited user message
        async function updateAIResponse(originalUserMessage, newUserMessage) {
            // Find and remove the last AI response
            const messages = document.querySelectorAll('.message-container');
            let lastAiMessage = null;
            
            // Iterate backwards to find the last AI message
            for (let i = messages.length - 1; i >= 0; i--) {
                if (!messages[i].querySelector('.message-user')) {
                    lastAiMessage = messages[i];
                    break;
                }
            }
            
            if (lastAiMessage) {
                // Show loading indicator
                lastAiMessage.style.display = 'none';
                addLoadingBubble();
                
                try {
                    // Get new AI response
                    const responseText = await callGeminiAPI(newUserMessage, state.currentFile);
                    removeLoadingBubble();
                    
                    // Update the AI message
                    const aiTextElement = lastAiMessage.querySelector('.prose');
                    if (aiTextElement) {
                        aiTextElement.innerHTML = marked.parse(responseText);
                        addCopyListeners();
                    }
                    
                    lastAiMessage.style.display = 'flex';
                    
                    // Update in history
                    const messageId = lastAiMessage.getAttribute('data-message-id');
                    updateMessageInHistory(messageId, responseText, 'ai');
                } catch (error) {
                    removeLoadingBubble();
                    lastAiMessage.style.display = 'flex';
                    console.error('Error updating AI response:', error);
                }
            }
        }

        // ================= UTILITIES =================

        function scrollToBottom() {
            const container = document.getElementById('chat-container');
            container.scrollTop = container.scrollHeight;
        }

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function setInput(text) {
            document.getElementById('chat-input').value = text;
        }

        function addCopyListeners() {
            document.querySelectorAll('pre code').forEach((block) => {
                const pre = block.parentNode;
                if (!pre.querySelector('.copy-btn')) {
                    const btn = document.createElement('button');
                    btn.className = 'copy-btn';
                    btn.innerHTML = '<i class="fa-regular fa-copy"></i> Salin';
                    btn.onclick = () => {
                        navigator.clipboard.writeText(block.innerText);
                        btn.innerHTML = '<i class="fa-solid fa-check"></i> Disalin!';
                        setTimeout(() => btn.innerHTML = '<i class="fa-regular fa-copy"></i> Salin', 2000);
                    };
                    pre.appendChild(btn);
                }
            });
        }

        // ================= FILE HANDLING =================
        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                state.currentFile = {
                    name: file.name,
                    type: file.type,
                    data: e.target.result,
                    rawContent: null
                };

                // If text file, try to read content
                if (file.type.includes('text') || file.name.endsWith('.txt') || file.name.endsWith('.js') || file.name.endsWith('.html') || file.name.endsWith('.py')) {
                     state.currentFile.rawContent = atob(e.target.result.split(',')[1]);
                }

                // Show UI
                document.getElementById('file-preview').classList.remove('hidden');
                document.getElementById('file-preview').classList.add('inline-flex');
                document.getElementById('preview-filename').innerText = file.name;
            };
            reader.readAsDataURL(file);
        }

        function clearFile() {
            state.currentFile = null;
            document.getElementById('file-input').value = '';
            document.getElementById('file-preview').classList.add('hidden');
            document.getElementById('file-preview').classList.remove('inline-flex');
        }

        // ================= MODEL SELECTION =================
        function openModelModal() {
            document.getElementById('model-modal').classList.remove('hidden');
        }

        function closeModelModal() {
            document.getElementById('model-modal').classList.add('hidden');
        }

        function selectModel(model) {
            state.currentModel = model;
            document.getElementById('current-model-text').textContent = model;
            closeModelModal();
            
            // Show additional options based on model
            if (model === 'AP-EDU') {
                setTimeout(() => {
                    openEduModal();
                }, 300);
            } else if (model === 'CARE-X') {
                setTimeout(() => {
                    openCareModal();
                }, 300);
            }
            
            // Reset specific settings when changing models
            state.currentSubject = null;
            state.currentCareMode = null;
        }

        // ================= AP-EDU SUBJECT SELECTION =================
        function openEduModal() {
            document.getElementById('edu-modal').classList.remove('hidden');
        }

        function closeEduModal() {
            document.getElementById('edu-modal').classList.add('hidden');
        }

        function selectSubject(subject) {
            state.currentSubject = subject;
            closeEduModal();
            
            // Show notification about selected subject
            showNotification(`Model AP-EDU dengan mata pelajaran ${subject} telah dipilih`, 'success');
        }

        // ================= CARE-X MODE SELECTION =================
        function openCareModal() {
            document.getElementById('care-modal').classList.remove('hidden');
        }

        function closeCareModal() {
            document.getElementById('care-modal').classList.add('hidden');
        }

        function selectCareMode(mode) {
            state.currentCareMode = mode;
            closeCareModal();
            
            // Show notification about selected mode
            showNotification(`Model CARE-X dengan mode ${mode} telah dipilih`, 'success');
        }

        // ================= LOCAL STORAGE & SETTINGS =================

        function loadState() {
            const savedUser = localStorage.getItem('apbot_user');
            const savedHistory = localStorage.getItem('apbot_history');

            if (savedUser) state.user = JSON.parse(savedUser);
            if (savedHistory) state.chatHistory = JSON.parse(savedHistory);

            updateUIProfile();
        }

        function saveState() {
            localStorage.setItem('apbot_user', JSON.stringify(state.user));
            localStorage.setItem('apbot_history', JSON.stringify(state.chatHistory));
        }

        function updateUIProfile() {
            document.getElementById('username-input').value = state.user.name;
            document.getElementById('user-initial').innerText = state.user.name.charAt(0);
            
            if (state.user.isVip) {
                document.getElementById('vip-badge').classList.remove('hidden');
                document.getElementById('user-status').innerText = "VIP Account";
                document.getElementById('user-status').classList.add('text-yellow-400');
                document.getElementById('upgrade-container').innerHTML = `<div class="text-center text-[10px] text-yellow-500 font-bold border border-yellow-500/30 bg-yellow-500/10 rounded p-1">VIP AKTIF</div>`;
            }
        }

        function updateUsername(newName) {
            state.user.name = newName;
            saveState();
            updateUIProfile();
        }

        function upgradeToVip() {
            state.user.isVip = true;
            saveState();
            updateUIProfile();
            alert("Selamat! Akun Anda telah diupgrade ke VIP (Gratis)!");
        }

        function openSettings() {
            document.getElementById('settings-modal').classList.remove('hidden');
            
            // Load current settings
            document.getElementById('profile-name').value = state.user.name;
            document.getElementById('language-select').value = state.user.language;
            document.getElementById('personality-select').value = state.user.personality;
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function saveSettings() {
            state.user.name = document.getElementById('profile-name').value;
            state.user.language = document.getElementById('language-select').value;
            state.user.personality = document.getElementById('personality-select').value;
            
            saveState();
            updateUIProfile();
            closeSettingsModal();
            showNotification('Pengaturan berhasil disimpan!', 'success');
        }

        // ================= HISTORY SYSTEM =================

        function createNewChatSession(firstMessage) {
            state.currentChatId = Date.now();
            const title = firstMessage.length > 20 ? firstMessage.substring(0, 20) + '...' : firstMessage;
            state.chatHistory.unshift({
                id: state.currentChatId,
                title: title,
                timestamp: new Date().toISOString(),
                messages: []
            });
            saveState();
            renderHistory();
        }

        function saveMessageToHistory(sender, text, filename) {
            if (!state.currentChatId) return;
            const chat = state.chatHistory.find(c => c.id === state.currentChatId);
            if (chat) {
                chat.messages.push({ sender, text, filename });
                saveState();
            }
        }

        function updateMessageInHistory(messageId, newText, sender = 'user') {
            if (!state.currentChatId) return;
            const chat = state.chatHistory.find(c => c.id === state.currentChatId);
            if (chat) {
                // Find the message with the given ID
                const messageIndex = chat.messages.findIndex(m => 
                    m.sender === sender && m.text === newText
                );
                
                if (messageIndex !== -1) {
                    chat.messages[messageIndex].text = newText;
                    saveState();
                }
            }
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';

            // Group by date (simplified for now just list)
            if (state.chatHistory.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 text-xs mt-4">Belum ada riwayat</div>';
                return;
            }

            state.chatHistory.forEach(chat => {
                const div = document.createElement('div');
                div.className = 'group flex items-center gap-2 p-3 rounded-lg hover:bg-white/5 cursor-pointer transition-colors relative';
                div.onclick = () => loadChatSession(chat.id);
                
                div.innerHTML = `
                    <i class="fa-regular fa-message text-gray-500 group-hover:text-gray-300"></i>
                    <div class="flex-1 overflow-hidden">
                        <p class="text-sm font-medium truncate text-gray-400 group-hover:text-gray-200" id="title-${chat.id}">${chat.title}</p>
                        <input type="text" value="${chat.title}" class="hidden w-full bg-black border border-indigo-500 text-xs p-1 rounded" id="edit-${chat.id}" onclick="event.stopPropagation()" onchange="saveTitle(${chat.id}, this.value)">
                    </div>
                    <div class="hidden group-hover:flex gap-2 absolute right-2 bg-[#1a1a26] px-1">
                        <button onclick="event.stopPropagation(); toggleEditTitle(${chat.id})" class="text-gray-400 hover:text-blue-400"><i class="fa-solid fa-pen text-xs"></i></button>
                        <button onclick="event.stopPropagation(); deleteChat(${chat.id})" class="text-gray-400 hover:text-red-400"><i class="fa-solid fa-trash text-xs"></i></button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function toggleEditTitle(id) {
            const p = document.getElementById(`title-${id}`);
            const input = document.getElementById(`edit-${id}`);
            if (input.classList.contains('hidden')) {
                p.classList.add('hidden');
                input.classList.remove('hidden');
                input.focus();
            } else {
                p.classList.remove('hidden');
                input.classList.add('hidden');
            }
        }

        function saveTitle(id, newTitle) {
            const chat = state.chatHistory.find(c => c.id === id);
            if (chat) {
                chat.title = newTitle;
                saveState();
                renderHistory();
            }
        }

        function deleteChat(id) {
            if(confirm("Hapus obrolan ini?")) {
                state.chatHistory = state.chatHistory.filter(c => c.id !== id);
                if (state.currentChatId === id) {
                    startNewChat();
                }
                saveState();
                renderHistory();
            }
        }

        function loadChatSession(id) {
            state.currentChatId = id;
            const chat = state.chatHistory.find(c => c.id === id);
            if (!chat) return;

            // UI Reset
            document.getElementById('welcome-screen').style.display = 'none';
            const area = document.getElementById('messages-area');
            area.classList.remove('hidden');
            area.innerHTML = '';

            // Close sidebar on mobile
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');

            // Replay messages
            chat.messages.forEach(msg => {
                addMessageToUI(msg.sender, msg.text, msg.filename ? {name: msg.filename, type: 'file'} : null);
            });
        }

        function startNewChat() {
            state.currentChatId = null;
            document.getElementById('messages-area').innerHTML = '';
            document.getElementById('messages-area').classList.add('hidden');
            document.getElementById('welcome-screen').style.display = 'flex';
            
            // Close sidebar mobile
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.add('hidden');
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg text-white text-sm z-50 animate-fade-in-up ${
                type === 'success' ? 'bg-green-600' : 
                type === 'error' ? 'bg-red-600' : 
                'bg-indigo-600'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Setup Animation helper
        const styleSheet = document.createElement("style");
        styleSheet.textContent = `
            @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
            .animate-fade-in-up { animation: fadeInUp 0.4s ease-out forwards; }
        `;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>
