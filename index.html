<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AP-CHATBOT AI - Wates Team</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Space+Grotesk:wght@500;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        'glass': 'rgba(255, 255, 255, 0.05)',
                        'glass-border': 'rgba(255, 255, 255, 0.1)',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-20px)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.4); }

        /* Background Animation */
        .animated-bg {
            background: radial-gradient(circle at 50% 50%, #0f0f1a 0%, #000000 100%);
            position: relative;
            overflow: hidden;
        }
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            z-index: 0;
            pointer-events: none;
        }
        .orb-1 { width: 300px; height: 300px; background: #4f46e5; top: -50px; left: -50px; animation: float 8s infinite; }
        .orb-2 { width: 400px; height: 400px; background: #7c3aed; bottom: -100px; right: -100px; animation: float 10s infinite reverse; }
        
        /* Glass Classes */
        .glass-panel {
            background: rgba(20, 20, 30, 0.75);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Typography & Elements */
        .message-user {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            color: white;
        }
        .message-ai {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
        }
        
        /* Markdown & Table Styling */
        .prose table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 1rem 0;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .prose th {
            background: rgba(99, 102, 241, 0.2);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #fff;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .prose td {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: #cbd5e1;
        }
        .prose tr:last-child td { border-bottom: none; }
        .prose strong { color: #fff; font-weight: 700; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin: 0.5rem 0; }
        .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin: 0.5rem 0; }
        .prose p { margin-bottom: 0.5rem; }

        /* Code Block */
        pre {
            background: #111 !important;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 0.5rem 0;
            overflow-x: auto;
            border: 1px solid #333;
            position: relative;
        }
        code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: #a5b4fc;
        }
        
        /* Controls */
        .action-btn {
            opacity: 0;
            transition: all 0.2s;
        }
        .message-container:hover .action-btn { opacity: 1; }
        
        /* Login Overlay */
        #login-overlay {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Loading Screen */
        #loading-screen { transition: opacity 0.8s ease-out, visibility 0.8s; }
        .loaded #loading-screen { opacity: 0; visibility: hidden; }
        
        /* Mobile Tweaks */
        @media (max-width: 768px) {
            .sidebar { width: 100% !important; max-width: 85vw; }
            .action-btn { opacity: 1; } /* Always show edit on mobile */
        }
    </style>
</head>
<body class="bg-black text-white h-screen overflow-hidden antialiased selection:bg-indigo-500 selection:text-white">

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyApzAYFUZRbGYezegZn1xEoAb_9wtZj2yE",
            authDomain: "ap-chatbot-a50d9.firebaseapp.com",
            databaseURL: "https://ap-chatbot-a50d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ap-chatbot-a50d9",
            storageBucket: "ap-chatbot-a50d9.firebasestorage.app",
            messagingSenderId: "380034352286",
            appId: "1:380034352286:web:628d3175e8710926dee78f",
            measurementId: "G-RZD4FV9KYZ"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
    </script>

    <div id="login-overlay">
        <div class="absolute inset-0 overflow-hidden">
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[500px] h-[500px] bg-indigo-600 rounded-full blur-[150px] opacity-20 animate-pulse-slow"></div>
        </div>
        
        <div class="glass-panel p-8 rounded-3xl w-full max-w-md relative z-10 space-y-6 text-center m-4 shadow-2xl shadow-indigo-500/20">
            <div class="w-20 h-20 mx-auto bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg mb-4">
                <i class="fa-solid fa-robot text-4xl text-white"></i>
            </div>
            <div>
                <h1 class="text-3xl font-display font-bold mb-2">AP-CHATBOT</h1>
                <p class="text-gray-400 text-sm">Masuk untuk menyimpan riwayat percakapan.</p>
            </div>

            <button onclick="loginWithGoogle()" class="w-full py-3 bg-white text-black rounded-xl font-bold flex items-center justify-center gap-3 hover:bg-gray-100 transition transform hover:scale-[1.02]">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
                Masuk dengan Google
            </button>

            <div class="flex items-center gap-3 text-gray-500 text-xs">
                <div class="h-px bg-gray-700 flex-1"></div>
                <span>ATAU MANUAL</span>
                <div class="h-px bg-gray-700 flex-1"></div>
            </div>

            <div class="space-y-3 text-left">
                <div>
                    <input type="email" id="email-input" placeholder="Email Address" class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-indigo-500">
                </div>
                <div>
                    <input type="password" id="password-input" placeholder="Password" class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-indigo-500">
                </div>
                <div class="flex gap-3">
                    <button onclick="handleAuth('login')" class="flex-1 py-3 bg-indigo-600/20 border border-indigo-500/50 text-indigo-300 rounded-xl font-bold hover:bg-indigo-600 hover:text-white transition">Login</button>
                    <button onclick="handleAuth('signup')" class="flex-1 py-3 bg-purple-600/20 border border-purple-500/50 text-purple-300 rounded-xl font-bold hover:bg-purple-600 hover:text-white transition">Daftar</button>
                </div>
            </div>
            <p id="auth-error" class="text-red-400 text-xs hidden"></p>
        </div>
    </div>

    <div id="loading-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-black hidden">
        <div class="absolute inset-0 overflow-hidden">
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 h-96 bg-indigo-600 rounded-full blur-[120px] opacity-20 animate-pulse-slow"></div>
        </div>
        <div class="relative z-10 text-center space-y-6">
            <div class="mx-auto w-24 h-24 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-[0_0_30px_rgba(99,102,241,0.5)] animate-bounce">
                <i class="fa-solid fa-robot text-4xl text-white"></i>
            </div>
            <div class="w-64 h-1 bg-gray-800 rounded-full overflow-hidden mt-8 mx-auto relative">
                <div id="progress-bar" class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 w-0 transition-all ease-linear duration-[2000ms]"></div>
            </div>
            <p class="text-xs text-gray-500 mt-4">Sinkronisasi Database...</p>
        </div>
    </div>

    <div id="main-ui" class="h-full w-full flex animated-bg relative z-0 opacity-0 scale-95 transition-all duration-700">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>

        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-80 transform -translate-x-full md:translate-x-0 md:static md:flex flex-col glass-panel transition-transform duration-300 ease-in-out h-full border-r border-white/10">
            
            <div class="p-5 border-b border-white/10">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg">
                        <i class="fa-solid fa-robot text-white text-lg"></i>
                    </div>
                    <div>
                        <h2 class="font-display font-bold text-lg tracking-wide">AP-CHATBOT</h2>
                        <div id="version-badge" class="text-[10px] px-2 py-0.5 rounded-full bg-indigo-500/20 text-indigo-300 border border-indigo-500/30 font-medium inline-block">V4.2 STABLE</div>
                    </div>
                    <button onclick="toggleSidebar()" class="md:hidden ml-auto text-gray-400 hover:text-white">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                
                <div class="p-3 bg-white/5 rounded-xl border border-white/5 flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-sm font-bold relative shrink-0">
                        <img id="user-avatar" src="" class="w-full h-full rounded-full object-cover hidden">
                        <span id="user-initial">U</span>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <p id="display-username" class="text-sm font-bold text-white truncate">User</p>
                        <p id="user-email" class="text-[10px] text-gray-400 truncate">email@example.com</p>
                    </div>
                    <button onclick="openSettings()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-gear"></i></button>
                    <button onclick="logout()" class="text-red-400 hover:text-red-300 ml-1"><i class="fa-solid fa-power-off"></i></button>
                </div>

                <div class="md:hidden w-full p-2 bg-white/5 border border-white/10 rounded-xl mb-2 cursor-pointer flex items-center justify-between" onclick="openModelModal()">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-brain text-indigo-400"></i>
                        <span id="mobile-model-text" class="text-xs font-bold text-gray-200">AP-MIND V4</span>
                    </div>
                    <i class="fa-solid fa-chevron-down text-xs text-gray-500"></i>
                </div>

            </div>

            <div class="p-4">
                <button onclick="startNewChat()" class="w-full py-3 px-4 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 transition-all duration-300 flex items-center justify-center gap-2 hover:shadow-[0_0_15px_rgba(255,255,255,0.1)]">
                    <i class="fa-solid fa-plus text-indigo-400"></i>
                    <span class="font-medium text-sm">Obrolan Baru</span>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-3 space-y-2 history-list" id="history-list">
                </div>

            <div class="p-4 border-t border-white/10 bg-black/20">
                <div class="text-[10px] text-gray-400 leading-relaxed text-center">
                    AP-CHATBOT by <span class="text-indigo-400">APTECH</span> feat. <span class="text-purple-400">Wates Team</span>.
                </div>
            </div>
        </aside>

        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-30 hidden md:hidden"></div>

        <main class="flex-1 flex flex-col h-full relative w-full">
            
            <header class="md:hidden flex items-center justify-between p-4 glass-panel z-20 border-b border-white/10">
                <button onclick="toggleSidebar()" class="text-white p-2"><i class="fa-solid fa-bars text-xl"></i></button>
                <div class="flex items-center gap-2">
                     <span class="font-display font-bold">AP-CHATBOT</span>
                </div>
                <div class="w-8"></div>
            </header>

            <header class="hidden md:flex items-center justify-between p-4 glass-panel z-20 border-b border-white/10">
                <div class="flex items-center gap-2">
                     <span class="font-display font-bold">AP-CHATBOT</span>
                     <span class="text-[9px] bg-indigo-500/20 text-indigo-300 px-1.5 py-0.5 rounded">BETA</span>
                </div>
                
                <div class="model-selector flex items-center gap-2 bg-white/5 border border-white/10 rounded-full px-4 py-1.5 cursor-pointer hover:bg-white/10 transition" onclick="openModelModal()">
                    <span id="current-model-text" class="text-sm font-medium">AP-MIND V4</span>
                    <i class="fa-solid fa-chevron-down text-xs text-gray-400"></i>
                </div>
            </header>

            <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 pt-20 md:pt-10 space-y-6 scroll-smooth">
                
                <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center space-y-6">
                    <div class="w-24 h-24 rounded-3xl bg-gradient-to-br from-indigo-600 to-purple-700 flex items-center justify-center shadow-[0_0_50px_rgba(99,102,241,0.3)] mb-4 animate-float">
                        <i class="fa-solid fa-brain text-4xl text-white"></i>
                    </div>
                    <h2 class="text-3xl md:text-4xl font-display font-bold">Sugeng Rawuh, Slur!</h2>
                    <p class="text-gray-400 max-w-md text-sm md:text-base">
                        Aku AP-CHATBOT. Siap bantu tugas, curhat, coding, lan liyane. <br>Database aman, memori rapi.
                    </p>
                </div>

                <div id="messages-area" class="hidden w-full max-w-3xl mx-auto space-y-6 pb-4"></div>
            </div>

            <div class="p-4 md:p-6 w-full max-w-4xl mx-auto z-20">
                
                <div id="file-preview" class="hidden mb-2 glass-panel inline-flex items-center gap-3 px-3 py-2 rounded-lg text-xs text-indigo-300 border-l-2 border-indigo-500 animate-fade-in">
                    <i class="fa-solid fa-file-lines text-lg"></i>
                    <div class="flex flex-col">
                        <span class="font-bold truncate max-w-[150px]" id="preview-filename">file.txt</span>
                    </div>
                    <button onclick="clearFile()" class="hover:text-white ml-2 bg-white/10 rounded-full w-5 h-5 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
                </div>

                <div class="glass-panel rounded-2xl p-2 flex flex-col relative shadow-2xl shadow-black/50 transition-all focus-within:ring-1 focus-within:ring-indigo-500/50">
                    <textarea id="chat-input" rows="1" class="w-full bg-transparent text-white placeholder-gray-500 text-sm md:text-base p-3 focus:outline-none resize-none max-h-32 font-sans" placeholder="Ketik pesen ning kene, Slur..." onkeydown="handleEnter(event)"></textarea>

                    <div class="flex items-center justify-between px-2 pb-1 mt-2">
                        <div class="flex items-center gap-1">
                            <label class="p-2 rounded-lg text-gray-400 hover:text-indigo-400 hover:bg-indigo-500/10 transition cursor-pointer">
                                <i class="fa-solid fa-paperclip"></i>
                                <input type="file" id="file-input" class="hidden" onchange="handleFileSelect(this)">
                            </label>
                        </div>
                        <button onclick="sendMessage()" id="send-btn" class="p-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-600/30 transition-all transform hover:scale-105 active:scale-95">
                            <i class="fa-solid fa-paper-plane text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="model-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass-panel rounded-2xl p-6 w-full max-w-md animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Pilih Model AI</h3>
                <button onclick="closeModal('model-modal')" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="space-y-3">
                <div onclick="selectModel('AP-MIND V4')" class="p-4 rounded-xl glass-panel hover:bg-white/10 cursor-pointer transition flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-indigo-600 flex items-center justify-center"><i class="fa-solid fa-brain text-white"></i></div>
                    <div><h4 class="font-bold">AP-MIND V4</h4><p class="text-xs text-gray-400">General purpose, coding, analisis.</p></div>
                </div>
                <div onclick="selectModel('AP-EDU')" class="p-4 rounded-xl glass-panel hover:bg-white/10 cursor-pointer transition flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-teal-600 flex items-center justify-center"><i class="fa-solid fa-graduation-cap text-white"></i></div>
                    <div><h4 class="font-bold">AP-EDU</h4><p class="text-xs text-gray-400">Spesialis edukasi, format tabel rapi.</p></div>
                </div>
                <div onclick="selectModel('CARE-X')" class="p-4 rounded-xl glass-panel hover:bg-white/10 cursor-pointer transition flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-pink-600 flex items-center justify-center"><i class="fa-solid fa-heart text-white"></i></div>
                    <div><h4 class="font-bold">CARE-X</h4><p class="text-xs text-gray-400">Teman curhat, pacar, perhatian.</p></div>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass-panel rounded-2xl p-6 w-full max-w-md animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Pengaturan</h3>
                <button onclick="closeModal('settings-modal')" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">Bahasa Utama</label>
                    <select id="language-select" class="w-full bg-black/40 border border-white/20 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-indigo-500">
                        <option value="id">Bahasa Indonesia (Wajib)</option>
                        <option value="jw">Boso Jowo</option>
                        <option value="su">Basa Sunda</option>
                    </select>
                    <p class="text-[10px] text-gray-500 mt-1">*AI akan dipaksa menggunakan bahasa ini.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">Kepribadian AI</label>
                    <select id="personality-select" class="w-full bg-black/40 border border-white/20 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-indigo-500">
                        <option value="normal">Normal / Sopan</option>
                        <option value="toxic">Toxic / Bar-bar (Kearifan Lokal)</option>
                        <option value="formal">Formal / Resmi</option>
                    </select>
                </div>
                <button onclick="saveSettings()" class="w-full py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-white font-medium transition mt-4">
                    Simpan Pengaturan
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = 'AIzaSyBnoW5dq2DBb60bPygi75hbtHY4sWyL8_4'; // User provided key
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=' + API_KEY;

        let currentUser = null;
        let currentChatId = null;
        let currentModel = 'AP-MIND V4';
        let currentFile = null;
        
        // Settings Default
        let userSettings = {
            language: 'id',
            personality: 'normal'
        };

        // ================= AUTHENTICATION =================
        function handleAuth(type) {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            const errDisplay = document.getElementById('auth-error');

            if(!email || !password) {
                errDisplay.innerText = "Isi email dan password dulu bos!";
                errDisplay.classList.remove('hidden');
                return;
            }

            if (type === 'login') {
                auth.signInWithEmailAndPassword(email, password).catch(e => {
                    errDisplay.innerText = e.message;
                    errDisplay.classList.remove('hidden');
                });
            } else {
                auth.createUserWithEmailAndPassword(email, password).then((cred) => {
                    // Set default profile
                    return cred.user.updateProfile({ displayName: email.split('@')[0] });
                }).catch(e => {
                    errDisplay.innerText = e.message;
                    errDisplay.classList.remove('hidden');
                });
            }
        }

        function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(e => alert(e.message));
        }

        function logout() {
            auth.signOut();
            location.reload();
        }

        // Observer Auth State
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('loading-screen').classList.remove('hidden');
                
                // Load User Profile UI
                document.getElementById('display-username').innerText = user.displayName || "User";
                document.getElementById('user-email').innerText = user.email;
                document.getElementById('user-initial').innerText = (user.displayName || "U").charAt(0).toUpperCase();
                if(user.photoURL) {
                    const img = document.getElementById('user-avatar');
                    img.src = user.photoURL;
                    img.classList.remove('hidden');
                    document.getElementById('user-initial').classList.add('hidden');
                }

                // Load Data
                loadUserSettings();
                loadChatHistoryList();
            } else {
                document.getElementById('login-overlay').classList.remove('hidden');
            }
        });

        // ================= DATABASE & HISTORY =================
        function loadUserSettings() {
            const ref = db.ref(`users/${currentUser.uid}/settings`);
            ref.once('value', snapshot => {
                if (snapshot.exists()) {
                    userSettings = snapshot.val();
                }
                // Sync UI
                document.getElementById('language-select').value = userSettings.language;
                document.getElementById('personality-select').value = userSettings.personality;
            });
        }

        function loadChatHistoryList() {
            const ref = db.ref(`users/${currentUser.uid}/chats`).orderByChild('timestamp');
            ref.on('value', snapshot => {
                const list = document.getElementById('history-list');
                list.innerHTML = '';
                const chats = [];
                snapshot.forEach(child => {
                    chats.push({ key: child.key, ...child.val() });
                });
                
                // Reverse to show newest first
                chats.reverse().forEach(chat => {
                    const div = document.createElement('div');
                    div.className = `group flex items-center gap-2 p-3 rounded-lg hover:bg-white/5 cursor-pointer transition-colors relative ${currentChatId === chat.key ? 'bg-white/10 border border-indigo-500/30' : ''}`;
                    div.onclick = () => openChat(chat.key);
                    div.innerHTML = `
                        <i class="fa-regular fa-message text-gray-500"></i>
                        <div class="flex-1 overflow-hidden">
                            <p class="text-sm font-medium truncate text-gray-300">${chat.title || 'Percakapan Baru'}</p>
                            <span class="text-[10px] text-gray-500">${new Date(chat.timestamp).toLocaleDateString()}</span>
                        </div>
                        <button onclick="event.stopPropagation(); deleteChat('${chat.key}')" class="hidden group-hover:block text-gray-500 hover:text-red-400"><i class="fa-solid fa-trash text-xs"></i></button>
                    `;
                    list.appendChild(div);
                });

                // Animation Done
                document.getElementById('progress-bar').style.width = '100%';
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('hidden');
                    document.getElementById('main-ui').classList.remove('opacity-0', 'scale-95');
                }, 500);
            });
        }

        function openChat(chatId) {
            currentChatId = chatId;
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('messages-area').classList.remove('hidden');
            document.getElementById('messages-area').innerHTML = '';
            
            // Close Sidebar Mobile
            toggleSidebar();

            // Load Messages
            db.ref(`chats/${chatId}/messages`).on('value', snapshot => {
                const area = document.getElementById('messages-area');
                area.innerHTML = '';
                const messages = [];
                snapshot.forEach(c => messages.push({key: c.key, ...c.val()}));
                
                messages.forEach(msg => renderMessage(msg));
                scrollToBottom();
            });
        }

        function startNewChat() {
            const newKey = db.ref(`users/${currentUser.uid}/chats`).push().key;
            db.ref(`users/${currentUser.uid}/chats/${newKey}`).set({
                title: 'Percakapan Baru',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            openChat(newKey);
        }

        function deleteChat(key) {
            if(!confirm("Hapus chat ini?")) return;
            db.ref(`users/${currentUser.uid}/chats/${key}`).remove();
            db.ref(`chats/${key}`).remove();
            if(currentChatId === key) location.reload();
        }

        // ================= MESSAGING LOGIC =================
        
        function renderMessage(msg) {
            const area = document.getElementById('messages-area');
            const isUser = msg.sender === 'user';
            
            // HTML Content
            const content = isUser ? msg.text : marked.parse(msg.text);
            
            const div = document.createElement('div');
            div.className = `flex ${isUser ? 'justify-end' : 'justify-start'} gap-3 animate-fade-in message-container group relative`;
            div.id = `msg-${msg.key}`;
            
            let actions = '';
            if(isUser) {
                actions = `<button onclick="enableEdit('${msg.key}', '${escapeHtml(msg.text)}')" class="action-btn absolute top-2 right-2 text-gray-300 bg-black/50 p-1 rounded hover:text-white"><i class="fa-solid fa-pen text-xs"></i></button>`;
            } else {
                actions = `
                    <div class="flex gap-2 mt-2">
                        <button onclick="copyText(this)" class="text-[10px] text-gray-400 hover:text-white flex items-center gap-1"><i class="fa-regular fa-copy"></i> Salin</button>
                        <button onclick="regenerateResponse('${msg.key}')" class="text-[10px] text-gray-400 hover:text-indigo-400 flex items-center gap-1"><i class="fa-solid fa-rotate-right"></i> Jawab Ulang</button>
                    </div>
                `;
            }

            div.innerHTML = `
                ${!isUser ? '<div class="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center shrink-0"><i class="fa-solid fa-robot text-xs text-white"></i></div>' : ''}
                <div class="flex flex-col max-w-[85%] md:max-w-[75%] ${isUser ? 'items-end' : ''}">
                    <div class="${isUser ? 'message-user' : 'message-ai'} p-3 md:p-4 rounded-2xl ${isUser ? 'rounded-tr-sm' : 'rounded-tl-sm'} text-sm md:text-base shadow-lg prose prose-invert max-w-none relative">
                        ${msg.file ? `<div class="mb-2 text-xs p-2 bg-white/10 rounded flex items-center gap-2"><i class="fa-solid fa-file"></i> ${msg.file}</div>` : ''}
                        <div id="content-${msg.key}">${content}</div>
                        ${isUser ? actions : ''}
                    </div>
                    ${!isUser ? actions : ''}
                </div>
            `;
            area.appendChild(div);
        }

        async function sendMessage() {
            if (!currentChatId) startNewChat();
            
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            
            if (!text && !currentFile) return;
            
            input.value = '';
            input.style.height = 'auto';
            
            // Save User Message
            const msgData = {
                sender: 'user',
                text: text,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                file: currentFile ? currentFile.name : null
            };
            
            // Push User Msg to DB
            const msgRef = db.ref(`chats/${currentChatId}/messages`).push();
            await msgRef.set(msgData);
            
            // Update Chat Title if first message
            const msgsSnap = await db.ref(`chats/${currentChatId}/messages`).get();
            if (msgsSnap.numChildren() <= 1) {
                db.ref(`users/${currentUser.uid}/chats/${currentChatId}`).update({
                    title: text.substring(0, 30) + (text.length > 30 ? '...' : '')
                });
            }

            processAIResponse(text, currentFile);
            clearFile();
        }

        // ================= AI PROCESSING =================
        async function processAIResponse(prompt, fileData, targetMsgKey = null) {
            addLoadingBubble();
            
            // Get Context (Last 10 messages) for memory
            const snapshot = await db.ref(`chats/${currentChatId}/messages`).limitToLast(10).get();
            let historyContext = "";
            snapshot.forEach(child => {
                const val = child.val();
                if(val.sender === 'user') historyContext += `User: ${val.text}\n`;
                else historyContext += `AI: ${val.text}\n`;
            });

            // Generate System Prompt
            let systemPrompt = buildSystemPrompt();
            
            const payload = {
                contents: [{
                    parts: [
                        { text: systemPrompt + "\n\nRiwayat Chat:\n" + historyContext + "\n\nUser Input Baru: " + prompt }
                    ]
                }]
            };

            // Handle File Image
            if(fileData && fileData.type.startsWith('image/')) {
                payload.contents[0].parts.push({
                    inline_data: { mime_type: fileData.type, data: fileData.base64 }
                });
            } else if (fileData) {
                payload.contents[0].parts[0].text += `\n[Lampiran File: ${fileData.name}, Isi: ${fileData.content}]`;
            }

            try {
                // Fetch with Retry & Timeout Logic
                const aiText = await fetchWithRetry(payload);
                removeLoadingBubble();

                if (targetMsgKey) {
                    // Update existing AI message (Regenerate)
                    db.ref(`chats/${currentChatId}/messages/${targetMsgKey}`).update({
                        text: aiText,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                } else {
                    // New AI Message
                    db.ref(`chats/${currentChatId}/messages`).push({
                        sender: 'ai',
                        text: aiText,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                }

            } catch (error) {
                removeLoadingBubble();
                console.error(error);
                // Error Handling "System Busy"
                db.ref(`chats/${currentChatId}/messages`).push({
                    sender: 'ai',
                    text: "**[SISTEM]** Ai sedang sibuk atau koneksi API bermasalah. Mungkin butuh waktu pemulihan. Tunggu sebentar ya. \n\n_Salam, APBOT by Aptech Team_",
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        function buildSystemPrompt() {
            let prompt = `Kamu adalah AP-CHATBOT (Model: ${currentModel}), AI cerdas buatan AryaProject (Wates Team, Mojokerto).`;
            
            // Language Logic
            if (userSettings.language === 'id') prompt += " GUNAKAN BAHASA INDONESIA YANG BENAR. Jangan gunakan bahasa daerah kecuali diminta.";
            else if (userSettings.language === 'jw') prompt += " GUNAKAN BASA JOWO (Jawa Timuran) sing akrab.";
            else if (userSettings.language === 'su') prompt += " GUNAKAN BASA SUNDA yang akrab.";

            // Personality Logic
            if (userSettings.personality === 'toxic') {
                prompt += " MODE TOXIC AKTIF: Gunakan bahasa yang sangat kasar, bar-bar, dan nyeleneh layaknya teman tongkrongan emosi.";
                if (userSettings.language === 'jw') prompt += " Gunakan kata pisuhan khas Jawa: Jancok, Asu, Matamu, Gatel, Ndasmu.";
                if (userSettings.language === 'su') prompt += " Gunakan kata kasar Sunda: Anying, Goblog, Sia, Belegug.";
            } else if (userSettings.personality === 'formal') {
                prompt += " Gunakan bahasa yang sangat formal, sopan, dan akademis.";
            }

            // Model Specific
            if (currentModel === 'AP-EDU') {
                prompt += " Kamu adalah AP-EDU. JAWABLAH SOAL DALAM FORMAT TABEL MARKDOWN. Buat kolom No, Soal/Topik, Jawaban, dan Penjelasan. Akhiri dengan motivasi belajar.";
            } else if (currentModel === 'CARE-X') {
                prompt += " Kamu adalah CARE-X. Jadilah pacar/teman curhat yang perhatian, manis, dan suportif.";
            }

            return prompt;
        }

        // API Retry & Timeout Wrapper
        async function fetchWithRetry(payload, retries = 3) {
            const timeout = 180000; // 3 menit
            
            const fetchPromise = async () => {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error.message);
                return data.candidates[0].content.parts[0].text;
            };

            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error("Timeout")), timeout)
            );

            for (let i = 0; i < retries; i++) {
                try {
                    return await Promise.race([fetchPromise(), timeoutPromise]);
                } catch (err) {
                    if (i === retries - 1) throw err;
                    console.log(`Retrying API... (${i+1})`);
                    await new Promise(r => setTimeout(r, 2000)); // Wait 2s before retry
                }
            }
        }

        // ================= EDIT & REGENERATE =================
        
        function enableEdit(key, currentText) {
            // Fix unescape
            const rawText = unescapeHtml(currentText);
            const container = document.querySelector(`#msg-${key} .message-user`);
            const contentDiv = document.getElementById(`content-${key}`);
            
            // Create Editor
            const input = document.createElement('textarea');
            input.value = rawText;
            input.className = "w-full bg-black/20 text-white border border-white/20 rounded p-2 focus:outline-none h-auto resize-none";
            input.style.minHeight = "60px";
            
            const btnSave = document.createElement('button');
            btnSave.innerHTML = '<i class="fa-solid fa-check"></i> Save';
            btnSave.className = "mt-2 bg-white/20 hover:bg-white/30 px-3 py-1 rounded text-xs font-bold";
            btnSave.onclick = () => saveEdit(key, input.value);

            const btnCancel = document.createElement('button');
            btnCancel.innerHTML = '<i class="fa-solid fa-times"></i>';
            btnCancel.className = "mt-2 ml-2 text-gray-300 hover:text-white px-2 py-1 text-xs";
            btnCancel.onclick = () => {
                // Force re-render from DB to cancel
                db.ref(`chats/${currentChatId}/messages/${key}`).once('value', snap => renderMessage(snap.val()));
                // Reload chat basically to reset UI state
                openChat(currentChatId);
            };

            contentDiv.innerHTML = '';
            contentDiv.appendChild(input);
            contentDiv.appendChild(btnSave);
            contentDiv.appendChild(btnCancel);
            input.focus();
        }

        async function saveEdit(key, newText) {
            // 1. Update DB for User Message
            await db.ref(`chats/${currentChatId}/messages/${key}`).update({
                text: newText
            });

            // 2. Find Next AI Message to Regenerate
            // Get all messages
            const snapshot = await db.ref(`chats/${currentChatId}/messages`).orderByKey().startAfter(key).limitToFirst(1).get();
            let nextAiKey = null;
            snapshot.forEach(child => {
                if(child.val().sender === 'ai') nextAiKey = child.key;
            });

            // 3. Trigger AI Logic
            if(nextAiKey) {
                processAIResponse(newText, null, nextAiKey);
            } else {
                processAIResponse(newText, null); // If no answer yet, create new
            }
        }

        async function regenerateResponse(msgKey) {
            // Find previous user message
            // Note: Ideally we scan backwards, but for simplicity, we just fetch last user prompt context or ask user to re-type if context lost. 
            // Better approach: Just call processAI with last context.
            
            // Show loading on that specific bubble? Or remove and re-add.
            // Let's remove the old AI message and create a new one for "Regenerate" visual effect
            const prevMsgRef = db.ref(`chats/${currentChatId}/messages`).orderByKey().endBefore(msgKey).limitToLast(1);
            const snap = await prevMsgRef.get();
            let lastUserText = "";
            snap.forEach(c => lastUserText = c.val().text);

            if(lastUserText) {
                db.ref(`chats/${currentChatId}/messages/${msgKey}`).remove(); // Remove old answer
                processAIResponse(lastUserText, null); // Gen new
            }
        }

        // ================= UTILS =================
        function handleEnter(e) {
            if(e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
            // Auto height
            e.target.style.height = 'auto';
            e.target.style.height = e.target.scrollHeight + 'px';
        }

        function scrollToBottom() {
            const c = document.getElementById('chat-container');
            c.scrollTop = c.scrollHeight;
        }

        function addLoadingBubble() {
            const area = document.getElementById('messages-area');
            const div = document.createElement('div');
            div.id = 'loading-bubble';
            div.className = 'flex gap-3 animate-fade-in';
            div.innerHTML = `
                <div class="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center"><i class="fa-solid fa-robot text-xs text-white"></i></div>
                <div class="message-ai p-4 rounded-2xl rounded-tl-sm flex items-center gap-2">
                    <span class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce"></span>
                    <span class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce delay-75"></span>
                    <span class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce delay-150"></span>
                </div>
            `;
            area.appendChild(div);
            scrollToBottom();
        }

        function removeLoadingBubble() {
            const b = document.getElementById('loading-bubble');
            if(b) b.remove();
        }

        // File Handling
        function handleFileSelect(input) {
            const file = input.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                currentFile = {
                    name: file.name,
                    type: file.type,
                    base64: e.target.result.split(',')[1],
                    content: file.type.includes('text') ? atob(e.target.result.split(',')[1]) : "Binary Data"
                };
                document.getElementById('file-preview').classList.remove('hidden');
                document.getElementById('file-preview').classList.add('inline-flex');
                document.getElementById('preview-filename').innerText = file.name;
            };
            reader.readAsDataURL(file);
        }

        function clearFile() {
            currentFile = null;
            document.getElementById('file-input').value = '';
            document.getElementById('file-preview').classList.add('hidden');
            document.getElementById('file-preview').classList.remove('inline-flex');
        }

        // Settings & Modals
        function openModelModal() { document.getElementById('model-modal').classList.remove('hidden'); }
        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        function selectModel(m) {
            currentModel = m;
            document.getElementById('current-model-text').innerText = m;
            document.getElementById('mobile-model-text').innerText = m;
            closeModal('model-modal');
        }

        function saveSettings() {
            userSettings.language = document.getElementById('language-select').value;
            userSettings.personality = document.getElementById('personality-select').value;
            
            db.ref(`users/${currentUser.uid}/settings`).set(userSettings);
            closeModal('settings-modal');
            alert("Pengaturan tersimpan! AI akan menyesuaikan.");
        }

        function copyText(btn) {
            const text = btn.closest('.message-ai').querySelector('.prose').innerText;
            navigator.clipboard.writeText(text);
            btn.innerHTML = '<i class="fa-solid fa-check"></i> Disalin';
            setTimeout(() => btn.innerHTML = '<i class="fa-regular fa-copy"></i> Salin', 2000);
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('sidebar-overlay');
            sb.classList.toggle('-translate-x-full');
            ov.classList.toggle('hidden');
        }

        // HTML Escape helper for edit input
        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        function unescapeHtml(text) {
            const txt = document.createElement("textarea");
            txt.innerHTML = text;
            return txt.value;
        }

    </script>
</body>
</html>
