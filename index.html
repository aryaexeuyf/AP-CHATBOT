<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AP-CHATBOT AI - Wates Team (Login System)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyApzAYFUZRbGYezegZn1xEoAb_9wtZj2yE",
            authDomain: "ap-chatbot-a50d9.firebaseapp.com",
            databaseURL: "https://ap-chatbot-a50d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ap-chatbot-a50d9",
            storageBucket: "ap-chatbot-a50d9.firebasestorage.app",
            messagingSenderId: "380034352286",
            appId: "1:380034352286:web:628d3175e8710926dee78f",
            measurementId: "G-RZD4FV9KYZ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        window.auth = getAuth(app);
        window.googleProvider = new GoogleAuthProvider();
        
        // Expose functions globally
        window.signInGoogle = () => signInWithPopup(window.auth, window.googleProvider)
            .then((result) => handleLoginSuccess(result.user))
            .catch((error) => alert("Login Google Gagal: " + error.message));

        window.signInManual = (email, password) => signInWithEmailAndPassword(window.auth, email, password)
            .then((userCredential) => handleLoginSuccess(userCredential.user))
            .catch((error) => alert("Login Gagal: " + error.message));

        window.signUpManual = (email, password) => createUserWithEmailAndPassword(window.auth, email, password)
            .then((userCredential) => handleLoginSuccess(userCredential.user))
            .catch((error) => alert("Daftar Gagal: " + error.message));

        // Auth Listener
        onAuthStateChanged(window.auth, (user) => {
            if (user) {
                handleLoginSuccess(user);
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('main-ui').classList.add('hidden');
            }
        });

        function handleLoginSuccess(user) {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('loading-screen').classList.remove('hidden');
            
            // Update global state
            if(window.updateUserState) window.updateUserState(user);

            setTimeout(() => {
                document.getElementById('progress-bar').style.width = '100%';
            }, 100);
            setTimeout(() => {
                document.body.classList.add('loaded');
                if(window.initApp) window.initApp();
            }, 2000);
        }
    </script>
    
    <!-- FontAwesome & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Space+Grotesk:wght@500;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">

    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        'glass': 'rgba(255, 255, 255, 0.05)',
                        'glass-border': 'rgba(255, 255, 255, 0.1)',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-20px)' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* Core Styles */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
        
        .animated-bg { background: radial-gradient(circle at 50% 50%, #0f0f1a 0%, #000000 100%); position: relative; overflow: hidden; }
        .glass-panel { background: rgba(20, 20, 30, 0.7); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        .message-user { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); }
        .message-ai { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        /* Code Blocks */
        pre { background: #1e1e1e !important; border-radius: 0.5rem; padding: 1rem; margin: 0.5rem 0; overflow-x: auto; border: 1px solid #333; }
        code { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; }
        .copy-btn { position: absolute; top: 0.5rem; right: 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #aaa; font-size: 0.7rem; padding: 0.2rem 0.6rem; border-radius: 0.3rem; cursor: pointer; }
        
        /* Loading & Screens */
        #loading-screen { transition: opacity 0.8s ease-out, visibility 0.8s; }
        .loaded #loading-screen { opacity: 0; visibility: hidden; }
        #main-ui { opacity: 0; transform: scale(0.98); transition: opacity 1s ease-out, transform 1s ease-out; }
        .loaded #main-ui { opacity: 1; transform: scale(1); }
        
        /* Markdown Details */
        .prose strong { color: #e2e8f0; font-weight: 700; }
        .prose p { margin-bottom: 0.5rem; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; }
        .prose ol { list-style-type: decimal; padding-left: 1.5rem; }
        
        /* Table Styles (Only used if requested) */
        table { width: 100%; border-collapse: collapse; margin: 1rem 0; background: rgba(255,255,255,0.05); border-radius: 0.5rem; overflow: hidden; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
        th { background: rgba(99,102,241,0.2); }

        /* Auth Inputs */
        .auth-input { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 12px; border-radius: 8px; width: 100%; margin-bottom: 12px; outline: none; }
        .auth-input:focus { border-color: #6366f1; }

        @media (max-width: 768px) {
            .sidebar { width: 85vw !important; max-width: 320px; }
        }
    </style>
</head>
<body class="bg-black text-white h-screen overflow-hidden antialiased selection:bg-indigo-500 selection:text-white">

    <!-- ================= AUTH SCREEN ================= -->
    <div id="auth-screen" class="fixed inset-0 z-[200] flex flex-col items-center justify-center bg-black hidden">
        <div class="absolute inset-0 overflow-hidden">
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full h-full bg-gradient-to-br from-indigo-900/20 to-black"></div>
        </div>
        
        <div class="relative z-10 w-full max-w-md p-8 glass-panel rounded-2xl shadow-2xl border-t border-white/10 mx-4">
            <div class="text-center mb-8">
                <div class="mx-auto w-20 h-20 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-[0_0_30px_rgba(99,102,241,0.5)] mb-4">
                    <i class="fa-solid fa-robot text-3xl text-white"></i>
                </div>
                <h1 class="text-3xl font-display font-bold">AP-CHATBOT</h1>
                <p class="text-indigo-400 text-sm tracking-widest uppercase mt-1">Login Access</p>
            </div>

            <div id="login-form">
                <input type="email" id="auth-email" placeholder="Email Address" class="auth-input">
                <input type="password" id="auth-password" placeholder="Password" class="auth-input">
                
                <button onclick="handleManualLogin()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 rounded-xl font-bold mb-3 transition shadow-lg shadow-indigo-600/20">
                    Masuk
                </button>
                
                <div class="flex items-center gap-3 my-4">
                    <div class="h-px bg-white/10 flex-1"></div>
                    <span class="text-xs text-gray-500">ATAU</span>
                    <div class="h-px bg-white/10 flex-1"></div>
                </div>

                <button onclick="window.signInGoogle()" class="w-full py-3 bg-white hover:bg-gray-100 text-black rounded-xl font-bold flex items-center justify-center gap-2 transition">
                    <i class="fa-brands fa-google text-red-500"></i> Lanjut dengan Google
                </button>

                <p class="text-center text-xs text-gray-400 mt-6 cursor-pointer hover:text-indigo-400" onclick="toggleAuthMode()">
                    Belum punya akun? <span class="font-bold text-indigo-400">Daftar disini</span>
                </p>
            </div>
        </div>
    </div>

    <!-- ================= LOADING SCREEN ================= -->
    <div id="loading-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-black">
        <div class="absolute inset-0 overflow-hidden">
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 h-96 bg-indigo-600 rounded-full blur-[120px] opacity-20 animate-pulse-slow"></div>
        </div>
        <div class="relative z-10 text-center space-y-6">
            <div class="mx-auto w-24 h-24 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-[0_0_30px_rgba(99,102,241,0.5)] animate-bounce">
                <i class="fa-solid fa-robot text-4xl text-white"></i>
            </div>
            <div class="space-y-2">
                <h1 class="font-display text-4xl md:text-5xl font-bold tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-white via-gray-200 to-gray-400">
                    AP-CHATBOT
                </h1>
                <p class="text-indigo-400 font-medium tracking-[0.3em] text-sm uppercase animate-pulse">
                    by Wates Team
                </p>
            </div>
            <div class="w-64 h-1 bg-gray-800 rounded-full overflow-hidden mt-8 mx-auto relative">
                <div id="progress-bar" class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 w-0 transition-all ease-linear"></div>
            </div>
            <p class="text-xs text-gray-500 mt-4">Menyiapkan Otak AI...</p>
        </div>
    </div>

    <!-- ================= MAIN UI ================= -->
    <div id="main-ui" class="h-full w-full flex animated-bg relative z-0 hidden">
        <!-- Orbs -->
        <div class="orb orb-1"></div><div class="orb orb-2"></div>

        <!-- SIDEBAR -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-80 transform -translate-x-full md:translate-x-0 md:static md:flex flex-col glass-panel transition-transform duration-300 ease-in-out h-full border-r border-white/10">
            <div class="p-5 border-b border-white/10">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg">
                        <i class="fa-solid fa-robot text-white text-lg"></i>
                    </div>
                    <div>
                        <h2 class="font-display font-bold text-lg tracking-wide">AP-CHATBOT</h2>
                        <div id="version-badge" class="text-[10px] px-2 py-0.5 rounded-full bg-indigo-500/20 text-indigo-300 border border-indigo-500/30 font-medium inline-block">V 4.7 LOGIN</div>
                    </div>
                    <button onclick="toggleSidebar()" class="md:hidden ml-auto text-gray-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
                </div>
                
                <div class="p-3 bg-white/5 rounded-xl border border-white/5 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-sm font-bold relative">
                        <span id="user-initial">U</span>
                        <div id="vip-badge" class="hidden absolute -bottom-1 -right-1 bg-yellow-500 text-black text-[8px] px-1 rounded font-bold border border-black">VIP</div>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <input type="text" id="username-input" value="User" class="bg-transparent text-sm font-bold text-white w-full focus:outline-none focus:border-b border-indigo-500" onchange="updateUsername(this.value)">
                        <p id="user-status" class="text-xs text-gray-400">Free Account</p>
                    </div>
                    <button onclick="openSettings()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-gear"></i></button>
                </div>
                
                <div id="upgrade-container" class="mt-3">
                    <button onclick="upgradeToVip()" class="w-full py-2 px-3 rounded-lg bg-gradient-to-r from-yellow-600/20 to-yellow-500/20 border border-yellow-500/30 text-yellow-200 text-xs font-medium hover:bg-yellow-500/30 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-crown"></i> Upgrade ke VIP (Rp 0)
                    </button>
                </div>
            </div>
            <div class="p-4">
                <button onclick="startNewChat()" class="w-full py-3 px-4 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 transition-all duration-300 flex items-center justify-center gap-2 hover:shadow-[0_0_15px_rgba(255,255,255,0.1)]">
                    <i class="fa-solid fa-plus text-indigo-400"></i> <span class="font-medium text-sm">Obrolan Baru</span>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-3 space-y-2 history-list" id="history-list"></div>
            <div class="p-4 border-t border-white/10 bg-black/20">
                <div class="text-[10px] text-gray-400 leading-relaxed">
                    <strong class="text-gray-300 block mb-1">Info AI:</strong>
                    Dibuat oleh <span class="text-indigo-400">APTECH</span> feat. <span class="text-purple-400">AryaProject</span> & <span class="text-indigo-400">Wates Team</span>.
                    Asli Suroboyo/Mojokerto, Jawa Timur.
                </div>
            </div>
        </aside>
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-30 hidden md:hidden"></div>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col h-full relative w-full">
            <header class="flex items-center justify-between p-4 glass-panel z-20 border-b border-white/10">
                <div class="flex items-center gap-2 md:hidden">
                    <button onclick="toggleSidebar()" class="text-white p-2"><i class="fa-solid fa-bars text-xl"></i></button>
                </div>
                <div class="flex items-center gap-2">
                     <span class="font-display font-bold">AP-CHATBOT</span>
                     <span class="text-[9px] bg-indigo-500/20 text-indigo-300 px-1.5 py-0.5 rounded">FINAL</span>
                </div>
                <div class="model-selector" onclick="openModelModal()">
                    <span id="current-model-text">AP-MIND V4</span>
                    <i class="fa-solid fa-chevron-down text-xs"></i>
                </div>
            </header>

            <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 pt-4 space-y-6 scroll-smooth">
                <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center space-y-6">
                    <div class="w-24 h-24 rounded-3xl bg-gradient-to-br from-indigo-600 to-purple-700 flex items-center justify-center shadow-[0_0_50px_rgba(99,102,241,0.3)] mb-4 animate-float">
                        <i class="fa-solid fa-brain text-4xl text-white"></i>
                    </div>
                    <h2 class="text-3xl md:text-4xl font-display font-bold">Sugeng Rawuh, Slur!</h2>
                    <p class="text-gray-400 max-w-md text-sm md:text-base">
                        Aku AP-CHATBOT v4.7. Siap bantu coding, tugas, analisa, atau curhat. Login aman, fitur komplit.
                    </p>
                </div>
                <div id="messages-area" class="hidden w-full max-w-3xl mx-auto space-y-6 pb-4"></div>
            </div>

            <div class="p-4 md:p-6 w-full max-w-4xl mx-auto z-20">
                <div id="file-preview" class="hidden mb-2 glass-panel inline-flex items-center gap-3 px-3 py-2 rounded-lg text-xs text-indigo-300 border-l-2 border-indigo-500 animate-fade-in-up">
                    <i class="fa-solid fa-file-lines text-lg"></i>
                    <div class="flex flex-col">
                        <span class="font-bold truncate max-w-[150px]" id="preview-filename">file.txt</span>
                        <span class="text-[10px] text-gray-400">Siap dikirim</span>
                    </div>
                    <button onclick="clearFile()" class="hover:text-white ml-2 bg-white/10 rounded-full w-5 h-5 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
                </div>

                <div class="glass-panel rounded-2xl p-2 flex flex-col relative shadow-2xl shadow-black/50 transition-all focus-within:ring-1 focus-within:ring-indigo-500/50">
                    <textarea id="chat-input" rows="1" class="w-full bg-transparent text-white placeholder-gray-500 text-sm md:text-base p-3 focus:outline-none resize-none max-h-32 font-sans" placeholder="Ketik pesen ning kene, Slur..." onkeydown="handleEnter(event)"></textarea>
                    <div class="flex items-center justify-between px-2 pb-1 mt-2">
                        <div class="flex items-center gap-1">
                            <label class="p-2 rounded-lg text-gray-400 hover:text-indigo-400 hover:bg-indigo-500/10 transition cursor-pointer" title="Kirim Gambar/Dokumen">
                                <i class="fa-solid fa-paperclip"></i>
                                <input type="file" id="file-input" class="hidden" onchange="handleFileSelect(this)">
                            </label>
                        </div>
                        <button onclick="sendMessage()" id="send-btn" class="p-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-600/30 transition-all transform hover:scale-105 active:scale-95">
                            <i class="fa-solid fa-paper-plane text-sm"></i>
                        </button>
                    </div>
                </div>
                <p class="text-center text-[10px] text-gray-600 mt-3">AP-CHATBOT by APTECH | Wates Team Mojokerto</p>
            </div>
        </main>
    </div>

    <!-- MODALS -->
    <div id="model-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass-panel rounded-2xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Pilih Model AI</h3><button onclick="closeModelModal()"><i class="fa-solid fa-times"></i></button></div>
            <div class="space-y-3">
                <div onclick="selectModel('AP-MIND V4')" class="p-4 rounded-xl glass-panel hover:bg-white/10 cursor-pointer flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center"><i class="fa-solid fa-brain text-white"></i></div>
                    <div><h4 class="font-bold">AP-MIND V4 (Recommended)</h4><p class="text-xs text-gray-400">All-in-One: Coding, Tugas, Analisa</p></div>
                </div>
                <div onclick="selectModel('AP-EDU')" class="p-4 rounded-xl glass-panel hover:bg-white/10 cursor-pointer flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-green-500 to-teal-600 flex items-center justify-center"><i class="fa-solid fa-graduation-cap text-white"></i></div>
                    <div><h4 class="font-bold">AP-EDU</h4><p class="text-xs text-gray-400">Khusus Tugas Sekolah (No Coding)</p></div>
                </div>
                <div onclick="selectModel('CARE-X')" class="p-4 rounded-xl glass-panel hover:bg-white/10 cursor-pointer flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-pink-500 to-red-600 flex items-center justify-center"><i class="fa-solid fa-heart text-white"></i></div>
                    <div><h4 class="font-bold">CARE-X</h4><p class="text-xs text-gray-400">Teman Curhat (No Coding)</p></div>
                </div>
            </div>
        </div>
    </div>

    <div id="edu-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass-panel rounded-2xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Pilih Mapel</h3><button onclick="closeEduModal()"><i class="fa-solid fa-times"></i></button></div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="selectSubject('MTK')" class="p-3 rounded-xl glass-panel hover:bg-white/10">MTK</button>
                <button onclick="selectSubject('IPA')" class="p-3 rounded-xl glass-panel hover:bg-white/10">IPA</button>
                <button onclick="selectSubject('IPS')" class="p-3 rounded-xl glass-panel hover:bg-white/10">IPS</button>
                <button onclick="selectSubject('BHS INGGRIS')" class="p-3 rounded-xl glass-panel hover:bg-white/10">BHS INGGRIS</button>
                <button onclick="selectSubject('BHS INDO')" class="p-3 rounded-xl glass-panel hover:bg-white/10">BHS INDO</button>
                <button onclick="selectSubject('TIK/Coding Basic')" class="p-3 rounded-xl glass-panel hover:bg-white/10">TIK/Coding Basic</button>
                <button onclick="selectSubject('UMUM')" class="p-3 rounded-xl glass-panel hover:bg-white/10 col-span-2">UMUM</button>
            </div>
        </div>
    </div>

    <div id="care-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass-panel rounded-2xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Pilih Mode</h3><button onclick="closeCareModal()"><i class="fa-solid fa-times"></i></button></div>
            <div class="space-y-3">
                <button onclick="selectCareMode('PACAR')" class="w-full p-3 rounded-xl glass-panel hover:bg-white/10 text-left">‚ù§Ô∏è Mode Pacar</button>
                <button onclick="selectCareMode('TEMAN')" class="w-full p-3 rounded-xl glass-panel hover:bg-white/10 text-left">ü§ù Mode Teman Nongkrong</button>
                <button onclick="selectCareMode('PENDENGAR')" class="w-full p-3 rounded-xl glass-panel hover:bg-white/10 text-left">üëÇ Mode Pendengar Curhat</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass-panel rounded-2xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Pengaturan</h3><button onclick="closeSettingsModal()"><i class="fa-solid fa-times"></i></button></div>
            <div class="space-y-4">
                <div><label class="block text-sm mb-2">Nama Profil</label><input type="text" id="profile-name" class="w-full bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white"></div>
                <div><label class="block text-sm mb-2">Bahasa AI</label><select id="language-select" class="w-full bg-white/10 border border-white/20 rounded-lg px-3 py-2 bg-black text-white"><option value="id">Indonesia (Default)</option><option value="jw">Jawa (Slur)</option><option value="su">Sunda</option></select></div>
                <div><label class="block text-sm mb-2">Sifat AI</label><select id="personality-select" class="w-full bg-white/10 border border-white/20 rounded-lg px-3 py-2 bg-black text-white"><option value="normal">Normal (Friendly)</option><option value="toxic">Toxic (Kasar/Nyeleneh)</option><option value="formal">Formal</option></select></div>
                <button onclick="saveSettings()" class="w-full py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-white font-medium">Simpan</button>
            </div>
        </div>
    </div>

    <!-- LOGIC SYSTEM -->
    <script>
        const API_KEY = 'AIzaSyACPEXjzZ1LD30KbLj9tg8eecwWSHNIzlI'; 
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=' + API_KEY;

        let state = {
            user: { name: 'User', isVip: false, callsign: 'Slur', language: 'id', personality: 'normal' },
            currentChatId: null,
            chatHistory: [],
            currentFile: null,
            currentModel: 'AP-MIND V4',
            currentSubject: null,
            currentCareMode: null,
            activeSessionMessages: [] 
        };

        // Login Handlers
        window.updateUserState = (firebaseUser) => {
            state.user.name = firebaseUser.displayName || firebaseUser.email.split('@')[0];
            updateUIProfile();
        };
        window.initApp = () => {
            renderHistory();
            updateUIProfile();
            document.getElementById('main-ui').classList.remove('hidden');
        };

        function handleManualLogin() {
            const e = document.getElementById('auth-email').value, p = document.getElementById('auth-password').value;
            if(!e || !p) return alert("Isi email/password!");
            window.signInManual(e, p);
        }
        function toggleAuthMode() {
            const btn = document.querySelector('#login-form button');
            const txt = document.querySelector('#auth-screen p span');
            if(btn.innerText === "Masuk") {
                btn.innerText = "Daftar Akun";
                btn.onclick = () => window.signUpManual(document.getElementById('auth-email').value, document.getElementById('auth-password').value);
                txt.innerText = "Login disini";
            } else {
                btn.innerText = "Masuk";
                btn.onclick = handleManualLogin;
                txt.innerText = "Daftar disini";
            }
        }

        // Main Logic
        async function sendMessage(overrideText = null) {
            const input = document.getElementById('chat-input');
            const message = overrideText || input.value.trim();
            if (!message && !state.currentFile) return;

            if(!overrideText) { input.value = ''; input.style.height = 'auto'; }
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('messages-area').classList.remove('hidden');

            const msgId = Date.now();
            addMessageToUI('user', message, state.currentFile, msgId);

            if (!state.currentChatId) createNewChatSession(message);
            saveMessageToHistory('user', message, state.currentFile ? state.currentFile.name : null, msgId);
            state.activeSessionMessages.push({ role: 'user', parts: [{ text: message }] });

            addLoadingBubble();
            try {
                const responseText = await callGeminiAPI(message, state.currentFile);
                removeLoadingBubble();
                const aiMsgId = Date.now() + 1;
                addMessageToUI('ai', responseText, null, aiMsgId);
                state.activeSessionMessages.push({ role: 'model', parts: [{ text: responseText }] });
                saveMessageToHistory('ai', responseText, null, aiMsgId);
            } catch (error) {
                removeLoadingBubble();
                addMessageToUI('ai', "Maaf, sistem sedang sibuk atau koneksi tidak stabil. Coba lagi ya lur.");
            }
            clearFile();
        }

        async function callGeminiAPI(prompt, fileData) {
            let sysPrompt = `Identitas: Kamu adalah APBOT, AI buatan AryaProject (APTECH/Wates Team) dari Mojokerto, Jawa Timur. 
            Sifat: Friendly, manusiawi, enak diajak ngobrol, suka panggil user "${state.user.callsign}".
            PENTING: JANGAN PERNAH LUPA IDENTITASMU SEBAGAI CIPTAAN ARYAPROJECT.`;

            if (state.user.personality === 'toxic') sysPrompt += " Gunakan bahasa kasar/toxic/nyeleneh layaknya teman akrab yang lagi emosi.";
            else if (state.user.personality === 'formal') sysPrompt += " Gunakan bahasa formal dan sopan.";
            
            // MODEL LOGIC
            if (state.currentModel === 'AP-MIND V4') {
                sysPrompt += ` Kamu adalah model AP-MIND V4 (All-in-One). Kamu jago coding, analisa, dan tugas umum. 
                Jika diminta script/coding, BERIKAN LENGKAP dalam format code block (Markdown).
                Jangan pakai tabel untuk script.`;
            } 
            else if (state.currentModel === 'AP-EDU') {
                sysPrompt += ` Kamu adalah AP-EDU, guru privat yang asik tapi tegas soal integritas. Fokus mapel: ${state.currentSubject || 'Umum'}.
                
                ATURAN KERAS:
                1. JIKA DIMINTA BIKIN SCRIPT/CODING (HTML, JS, Python, dll): TOLAK dengan sopan. Bilang: "Waduh, kalau urusan coding/script itu ranahnya AP-MIND V4 lur. Aku khusus teori dan tugas sekolah aja. Ganti model gih ke AP-MIND."
                2. FORMAT JAWABAN TUGAS: JANGAN GUNAKAN TABEL (kecuali user minta tabel/diagram). Gunakan format Essay, Poin-poin, atau Daftar Nomor yang rapi.
                3. ANTI-NYONTEK: Berikan jawaban yang akurat 100%, TAPI di akhir jawaban WAJIB tambahkan teguran/sentilan pedas dikit biar user gak cuma copas. Contoh: "Jawaban udah bener iki, tapi awas lek mung mbok salin tok. Utekmu gak bakal pinter lek males mikir!" (Tanpa label 'nasihat', langsung saja).`;
            } 
            else if (state.currentModel === 'CARE-X') {
                sysPrompt += ` Kamu adalah CARE-X, mode: ${state.currentCareMode || 'Curhat'}.
                ATURAN KERAS:
                1. JIKA DIMINTA BIKIN SCRIPT/CODING: TOLAK dengan gaya sesuai mode. Bilang kamu gak ngerti coding, suruh ke AP-MIND V4.
                2. Fokus pada perasaan, empati, dan obrolan santai.`;
            }

            // Language Force
            if (state.user.language === 'id') sysPrompt += " Gunakan Bahasa Indonesia (boleh gaul).";
            else if (state.user.language === 'jw') sysPrompt += " Gunakan Bahasa Jawa (Jawa Timuran).";
            else if (state.user.language === 'su') sysPrompt += " Gunakan Bahasa Sunda.";

            let parts = [{ text: sysPrompt + "\n\nUser Request: " + prompt }];
            if (fileData) {
                if(fileData.type.startsWith('image/')) parts.push({ inline_data: { mime_type: fileData.type, data: fileData.data.split(',')[1] } });
                else parts[0].text += `\n\n[File: ${fileData.name}]\nContent: ${fileData.rawContent}`;
            }

            const payload = { contents: [...state.activeSessionMessages.slice(-8), { role: 'user', parts: parts }] };
            const res = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const data = await res.json();
            return data.candidates[0].content.parts[0].text;
        }

        // UI Rendering
        function addMessageToUI(sender, text, attachment, msgId) {
            const area = document.getElementById('messages-area');
            const isUser = sender === 'user';
            const html = `
                <div class="flex ${isUser ? 'justify-end' : 'justify-start'} gap-3 animate-fade-in-up message-container" id="msg-${msgId}">
                    ${!isUser ? `<div class="w-8 h-8 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center flex-shrink-0 shadow-lg"><i class="fa-solid fa-robot text-xs text-white"></i></div>` : ''}
                    <div class="flex flex-col ${isUser ? 'items-end' : 'items-start'} max-w-[85%] md:max-w-[75%]">
                        <div class="${isUser ? 'message-user text-white' : 'message-ai text-gray-200'} p-4 rounded-2xl ${isUser ? 'rounded-tr-sm' : 'rounded-tl-sm'} text-sm md:text-base leading-relaxed shadow-lg w-full prose prose-invert max-w-none relative group">
                            ${attachment ? (attachment.type.startsWith('image/') ? `<img src="${attachment.data}" class="rounded mb-2 max-w-[200px]">` : `<div class="mb-2 text-xs bg-white/10 p-1 rounded"><i class="fa-solid fa-file"></i> ${attachment.name}</div>`) : ''}
                            <div class="msg-content">${isUser ? text : marked.parse(text)}</div>
                            ${isUser ? `<button onclick="editMsg(${msgId})" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-xs text-white/70 hover:text-white"><i class="fa-solid fa-pen"></i></button>` : ''}
                        </div>
                    </div>
                    ${isUser ? `<div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center flex-shrink-0 border border-white/10 text-xs font-bold">${state.user.name.charAt(0)}</div>` : ''}
                </div>
            `;
            area.insertAdjacentHTML('beforeend', html);
            scrollToBottom();
            if(!isUser) addCopyListeners();
        }

        function editMsg(id) {
            const container = document.querySelector(`#msg-${id} .msg-content`);
            const text = container.innerText;
            container.innerHTML = `<textarea class="w-full bg-gray-900 text-white p-2 rounded border border-indigo-500 focus:outline-none text-sm" rows="3">${text}</textarea>
            <div class="flex gap-2 mt-2 justify-end"><button onclick="cancelEdit(${id}, '${text.replace(/'/g, "\\'")}')" class="text-xs text-red-400">Batal</button><button onclick="saveEdit(${id})" class="text-xs text-green-400 font-bold">Kirim Ulang</button></div>`;
        }
        function cancelEdit(id, oldText) { document.querySelector(`#msg-${id} .msg-content`).innerText = oldText; }
        async function saveEdit(id) {
            const newText = document.querySelector(`#msg-${id} textarea`).value;
            document.querySelector(`#msg-${id} .msg-content`).innerText = newText;
            // Remove following AI responses
            let next = document.getElementById(`msg-${id}`).nextElementSibling;
            while(next) { next.remove(); next = document.getElementById(`msg-${id}`).nextElementSibling; }
            
            addLoadingBubble();
            try {
                const res = await callGeminiAPI(newText, null);
                removeLoadingBubble();
                addMessageToUI('ai', res, null, Date.now());
            } catch(e) { removeLoadingBubble(); }
        }

        function addLoadingBubble() {
            document.getElementById('messages-area').insertAdjacentHTML('beforeend', `<div id="loading-bubble" class="flex gap-3 animate-fade-in-up"><div class="w-8 h-8 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center"><i class="fa-solid fa-robot text-xs text-white"></i></div><div class="message-ai p-4 rounded-2xl rounded-tl-sm"><span class="animate-pulse">...</span></div></div>`);
            scrollToBottom();
        }
        function removeLoadingBubble() { const el = document.getElementById('loading-bubble'); if(el) el.remove(); }
        function scrollToBottom() { const c = document.getElementById('chat-container'); c.scrollTop = c.scrollHeight; }
        function handleEnter(e) { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
        
        // Utils & History
        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            state.chatHistory.forEach(chat => {
                list.innerHTML += `
                <div class="group flex items-center gap-2 p-3 rounded-lg hover:bg-white/5 cursor-pointer relative" onclick="loadChat(${chat.id})">
                    <i class="fa-regular fa-message text-gray-500"></i>
                    <div class="flex-1 overflow-hidden">
                        <p class="text-sm font-medium truncate text-gray-400 group-hover:text-gray-200" id="t-${chat.id}">${chat.title}</p>
                        <input type="text" value="${chat.title}" class="hidden w-full bg-black border border-indigo-500 text-xs p-1 rounded text-white" id="e-${chat.id}" onclick="event.stopPropagation()" onchange="saveTitle(${chat.id}, this.value)">
                    </div>
                    <div class="hidden group-hover:flex gap-2 absolute right-2 bg-[#1a1a26] px-1 rounded">
                        <button onclick="event.stopPropagation(); toggleEditTitle(${chat.id})" class="text-gray-400 hover:text-blue-400"><i class="fa-solid fa-pen text-xs"></i></button>
                        <button onclick="event.stopPropagation(); deleteChat(${chat.id})" class="text-gray-400 hover:text-red-400"><i class="fa-solid fa-trash text-xs"></i></button>
                    </div>
                </div>`;
            });
        }
        function createNewChatSession(msg) {
            state.currentChatId = Date.now();
            state.chatHistory.unshift({ id: state.currentChatId, title: msg.substring(0, 20)+'...', messages: [] });
            localStorage.setItem('apbot_history_v4', JSON.stringify(state.chatHistory));
            renderHistory();
        }
        function saveMessageToHistory(sender, text, fname, id) {
            const chat = state.chatHistory.find(c => c.id === state.currentChatId);
            if(chat) { chat.messages.push({ sender, text, filename: fname, id }); localStorage.setItem('apbot_history_v4', JSON.stringify(state.chatHistory)); }
        }
        function loadChat(id) {
            state.currentChatId = id;
            const chat = state.chatHistory.find(c => c.id === id);
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('messages-area').classList.remove('hidden');
            document.getElementById('messages-area').innerHTML = '';
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.add('hidden');
            chat.messages.forEach(m => addMessageToUI(m.sender, m.text, m.filename ? {name: m.filename, type: 'file'} : null, m.id));
        }
        function deleteChat(id) {
            if(confirm("Hapus chat?")) { state.chatHistory = state.chatHistory.filter(c => c.id !== id); if(state.currentChatId === id) startNewChat(); localStorage.setItem('apbot_history_v4', JSON.stringify(state.chatHistory)); renderHistory(); }
        }
        function toggleEditTitle(id) {
            const t = document.getElementById(`t-${id}`), e = document.getElementById(`e-${id}`);
            if(e.classList.contains('hidden')) { t.classList.add('hidden'); e.classList.remove('hidden'); e.focus(); } else { t.classList.remove('hidden'); e.classList.add('hidden'); }
        }
        function saveTitle(id, val) {
            const chat = state.chatHistory.find(c => c.id === id); if(chat) chat.title = val; localStorage.setItem('apbot_history_v4', JSON.stringify(state.chatHistory)); renderHistory();
        }
        function startNewChat() {
            state.currentChatId = null; state.activeSessionMessages = [];
            document.getElementById('messages-area').innerHTML = ''; document.getElementById('messages-area').classList.add('hidden');
            document.getElementById('welcome-screen').style.display = 'flex';
            document.getElementById('sidebar').classList.add('-translate-x-full'); document.getElementById('sidebar-overlay').classList.add('hidden');
        }

        // File & Copy
        function handleFileSelect(input) {
            const file = input.files[0]; if(!file) return;
            const r = new FileReader();
            r.onload = (e) => {
                state.currentFile = { name: file.name, type: file.type, data: e.target.result, rawContent: file.type.includes('text') ? atob(e.target.result.split(',')[1]) : null };
                document.getElementById('file-preview').classList.remove('hidden'); document.getElementById('file-preview').classList.add('inline-flex'); document.getElementById('preview-filename').innerText = file.name;
            };
            r.readAsDataURL(file);
        }
        function clearFile() { state.currentFile = null; document.getElementById('file-input').value = ''; document.getElementById('file-preview').classList.add('hidden'); document.getElementById('file-preview').classList.remove('inline-flex'); }
        function addCopyListeners() {
            document.querySelectorAll('pre code').forEach((block) => {
                if(!block.parentNode.querySelector('.copy-btn')) {
                    const btn = document.createElement('button'); btn.className = 'copy-btn'; btn.innerHTML = '<i class="fa-regular fa-copy"></i> Salin';
                    btn.onclick = () => { navigator.clipboard.writeText(block.innerText); btn.innerHTML = '<i class="fa-solid fa-check"></i> Disalin!'; setTimeout(() => btn.innerHTML = '<i class="fa-regular fa-copy"></i> Salin', 2000); };
                    block.parentNode.appendChild(btn);
                }
            });
        }

        // Modals
        function openModelModal() { document.getElementById('model-modal').classList.remove('hidden'); }
        function closeModelModal() { document.getElementById('model-modal').classList.add('hidden'); }
        function selectModel(m) { 
            state.currentModel = m; document.getElementById('current-model-text').innerText = m; closeModelModal();
            if(m === 'AP-EDU') setTimeout(() => document.getElementById('edu-modal').classList.remove('hidden'), 300);
            if(m === 'CARE-X') setTimeout(() => document.getElementById('care-modal').classList.remove('hidden'), 300);
            state.currentSubject = null; state.currentCareMode = null;
        }
        function closeEduModal() { document.getElementById('edu-modal').classList.add('hidden'); }
        function selectSubject(s) { state.currentSubject = s; closeEduModal(); }
        function closeCareModal() { document.getElementById('care-modal').classList.add('hidden'); }
        function selectCareMode(m) { state.currentCareMode = m; closeCareModal(); }
        
        // Settings
        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); document.getElementById('profile-name').value = state.user.name; document.getElementById('language-select').value = state.user.language; document.getElementById('personality-select').value = state.user.personality; }
        function closeSettingsModal() { document.getElementById('settings-modal').classList.add('hidden'); }
        function saveSettings() {
            state.user.name = document.getElementById('profile-name').value;
            state.user.language = document.getElementById('language-select').value;
            state.user.personality = document.getElementById('personality-select').value;
            updateUIProfile(); closeSettingsModal();
        }
        function updateUIProfile() {
            document.getElementById('username-input').value = state.user.name;
            document.getElementById('user-initial').innerText = state.user.name.charAt(0);
            if(state.user.isVip) {
                document.getElementById('vip-badge').classList.remove('hidden');
                document.getElementById('user-status').innerText = "VIP Account"; document.getElementById('user-status').classList.add('text-yellow-400');
                document.getElementById('upgrade-container').innerHTML = `<div class="text-center text-[10px] text-yellow-500 font-bold border border-yellow-500/30 bg-yellow-500/10 rounded p-1">VIP AKTIF</div>`;
            }
        }
        function upgradeToVip() { state.user.isVip = true; updateUIProfile(); alert("Selamat! Anda VIP."); }
        function toggleSidebar() {
            const sb = document.getElementById('sidebar'), ov = document.getElementById('sidebar-overlay');
            sb.classList.toggle('-translate-x-full'); ov.classList.toggle('hidden');
        }

        // Load Data
        const savedH = localStorage.getItem('apbot_history_v4'); if(savedH) state.chatHistory = JSON.parse(savedH);
    </script>
</body>
</html>
